<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Intelligence 3.0 - Centro di Comando CRM</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --color-primary: #667eea;
            --color-primary-dark: #764ba2;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #3b82f6;
            --color-contatti: #8b5a2b;
            --color-lead: #16a34a;
            --color-prospect: #2563eb;
            --color-clienti: #ec4899;
            --color-ghost: #dc2626;
            --color-fatturato: #1f2937;
            --perf-critical: #dc2626;
            --perf-low: #ea580c;
            --perf-medium: #ca8a04;
            --perf-good: #16a34a;
            --perf-excellent: #15803d;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.6s ease;
        }

        * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
        .gradient-bg { background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%); }
        .card-hover { transition: all var(--transition-normal); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); }
        .file-upload-area { border: 2px dashed #cbd5e0; transition: all var(--transition-normal); border-radius: 0.5rem; cursor: pointer; }
        .file-upload-area:hover { border-color: var(--color-info); background-color: #f7fafc; }
        .file-upload-area.dragover { border-color: var(--color-success); background-color: #f0fff4; }
        .file-upload-area.loaded { border-color: var(--color-success); background-color: #f0fff4; }
        .file-upload-area.error { border-color: var(--color-danger); background-color: #fed7d7; }
        .status-indicator { display: inline-flex; align-items: center; gap: var(--spacing-xs); }
        .fade-in { animation: fadeIn var(--transition-slow) ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .debug-panel { background: #1a1a1a; color: #00ff00; font-family: 'Courier New', monospace; font-size: 12px; padding: var(--spacing-md); border-radius: 8px; margin: var(--spacing-md) 0; max-height: 300px; overflow-y: auto; }
        .debug-section { border-bottom: 1px solid #333; padding: var(--spacing-sm) 0; }
        .debug-error { color: #ff4444; }
        .debug-success { color: #44ff44; }
        .debug-warning { color: #ffaa44; }
        
        .export-btn, .section-export-btn {
            transition: all var(--transition-normal);
        }
        .export-btn:hover:not(:disabled), .section-export-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .chart-clickable { cursor: pointer; transition: opacity var(--transition-fast); }
        .chart-clickable:hover { opacity: 0.8; }
        .modal-overlay { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .modal-content { max-height: 80vh; overflow-y: auto; }
        .filter-select, .date-input { width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; background: white; font-size: 0.875rem; transition: all var(--transition-fast); position: relative; z-index: 1; }
        .filter-select { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .filter-select:focus, .date-input:focus { outline: none; border-color: var(--color-info); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); z-index: 10; }
        .date-inputs-container { display: none; position: relative; z-index: 1; }
        .date-inputs-container.show { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-top: var(--spacing-md); }
        .date-input::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 1; }
        .data-contatti { color: var(--color-contatti); font-weight: 600; }
        .data-lead { color: var(--color-lead); font-weight: 600; }
        .data-prospect { color: var(--color-prospect); font-weight: 600; }
        .data-clienti { color: var(--color-clienti); font-weight: 600; }
        .data-fatturato { color: var(--color-fatturato); font-weight: 600; }
        .performance-table { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 1fr; gap: var(--spacing-md); align-items: center; padding: 0.75rem var(--spacing-md); border-bottom: 1px solid #e5e7eb; transition: background-color var(--transition-fast); }
        .performance-table.header { background: #f8fafc; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db; position: sticky; top: 0; z-index: 10; }
        .performance-table:hover:not(.header) { background: #f9fafb; }
        .performance-table .numeric-col { text-align: center; font-variant-numeric: tabular-nums; font-weight: 600; }
        .performance-table .fonte-col { text-align: left; font-weight: 600; color: var(--color-fatturato); }
        .performance-table .percentage-col { text-align: center; font-variant-numeric: tabular-nums; }
        .performance-table .fatturato-col { text-align: center; font-variant-numeric: tabular-nums; font-weight: 600; }
        .badge { display: inline-flex; padding: 0.25rem 0.75rem; font-weight: 700; font-size: 0.9rem; border-radius: 9999px; letter-spacing: 0.5px; }
        .badge-critical { background-color: #fee2e2; color: var(--perf-critical); }
        .badge-low { background-color: #ffedd5; color: var(--perf-low); }
        .badge-medium { background-color: #fef9c3; color: var(--perf-medium); }
        .badge-good { background-color: #dcfce7; color: var(--perf-good); }
        .badge-excellent { background-color: #bbf7d0; color: var(--perf-excellent); }
        .totali-row { background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-top: 2px solid #d1d5db; font-weight: 700; color: #111827; }
        .agg-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.875rem; color: #4b5563; transition: all 0.2s ease; border: none; background-color: transparent; cursor: pointer; }
        .agg-btn.active { color: #2563eb; background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        @media (max-width: 1024px) { .performance-table { grid-template-columns: 1.5fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr; gap: var(--spacing-sm); padding: var(--spacing-sm); font-size: 0.875rem; } }

        /* üÜï STILI PER CARICAMENTO URL */
        .mode-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: var(--spacing-md);
            align-items: center;
        }
        .mode-btn {
            flex: 1;
            padding: 0.625rem 1rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .mode-btn:hover {
            border-color: var(--color-info);
            background: #f0f9ff;
        }
        .mode-btn.active {
            background: var(--color-info);
            color: white;
            border-color: var(--color-info);
        }
        .help-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 50%;
            cursor: help;
            transition: all var(--transition-fast);
        }
        .help-icon:hover {
            background: var(--color-info);
            color: white;
            transform: scale(1.1);
        }
        .upload-mode {
            transition: all var(--transition-normal);
        }
        .upload-mode.hidden {
            display: none;
        }
        .url-input-container {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: var(--spacing-md);
        }
        .url-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .url-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            font-family: 'Courier New', monospace;
            transition: all var(--transition-fast);
        }
        .url-input:focus {
            outline: none;
            border-color: var(--color-info);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .url-input::placeholder {
            color: #9ca3af;
            font-family: 'Inter', sans-serif;
        }
        .save-url-btn {
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.375rem;
            border: 2px solid #d1d5db;
            background-color: #f9fafb;
            color: #4b5563;
        }
        .save-url-btn:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }
        .save-url-btn.saved {
            background-color: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }
        .load-url-btn {
            width: 100%;
            margin-top: var(--spacing-md);
            padding: 0.875rem;
            background: linear-gradient(135deg, var(--color-info) 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .load-url-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .load-url-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .url-status {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: 6px;
            font-size: 0.875rem;
            display: none;
        }
        .url-status.show {
            display: block;
        }
        .url-status.loading {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .url-status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        .url-status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .url-tutorial {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 6px;
            font-size: 0.813rem;
            line-height: 1.5;
            display: none;
        }
        .url-tutorial.show {
            display: block;
        }
        .url-tutorial strong {
            color: #92400e;
            display: block;
            margin-bottom: 0.5rem;
        }
        .url-tutorial ol {
            margin-left: 1.25rem;
            color: #78350f;
        }
        /* *** INIZIO MODIFICA v39 *** */
        .url-tutorial code {
            background: #fef3c7;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            word-break: break-all; /* Aggiunta propriet√† per il wrapping */
        }
        /* *** FINE MODIFICA v39 *** */
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-3xl mr-3"></i>
                    <span class="text-3xl mr-3">üéØ</span>
                    <div>
                        <h1 class="text-2xl font-bold">Dashboard - Centro di Comando CRM</h1>
                        <p class="text-purple-200 text-sm">ROI e Performance Analysis</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="exportFullDashboard" class="export-btn bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-file-pdf mr-2"></i>
                        Esporta Dashboard Completa
                    </button>
                    <button id="toggleDebug" class="bg-red-500 text-white px-3 py-1 rounded text-sm">üõ† Debug</button>
                    <span id="dataStatus" class="status-indicator bg-white/20 px-3 py-1 rounded-full text-sm">
                        <i class="fas fa-circle text-yellow-300"></i>
                        In attesa dei dati
                    </span>
                    <span id="dateTimeDisplay" class="status-indicator bg-white/20 px-3 py-1 rounded-full text-sm hidden">
                        <i class="fas fa-clock mr-2"></i>
                        <span id="dateTimeValue"></span>
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- DEBUG PANEL -->
    <div id="debugPanel" class="container mx-auto px-4 py-2" style="display: none;">
        <div class="debug-panel">
            <h3 class="debug-success">üõ† DEBUG CONSOLE - DASHBOARD INTEGRATA</h3>
            <div id="debugContent">
                <div class="debug-section">Sistema inizializzato. In attesa di dati...</div>
            </div>
        </div>
    </div>

    <!-- MODAL DRILL-DOWN DISPERSIONI -->
    <div id="drillDownModal" class="fixed inset-0 z-50 hidden modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full modal-content">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800" id="modalTitle">Analisi Dispersioni e Tassi di Conversione per Fonte</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div id="modalContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PERFORMANCE PER FONTE -->
    <div id="performanceModal" class="fixed inset-0 z-50 hidden modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full modal-content">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800" id="performanceModalTitle">üíé Performance Dettagliata per Fonte</h3>
                    <button id="closePerformanceModal" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div id="performanceModalContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6">
        <!-- Sezione Caricamento Multi-Report (4 FILE) -->
        <div class="mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold mb-6 flex items-center text-gray-800">
                    <i class="fas fa-upload text-blue-500 mr-3 text-2xl"></i>
                    üìÅ Caricamento Multi-Report
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Report Lead -->
                    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4">
                        <h3 class="font-semibold text-green-800 mb-3">
                            <i class="fas fa-users mr-2"></i>Report Lead
                            <span class="bg-green-500 text-white text-xs px-2 py-1 rounded-full ml-2">Obbligatorio</span>
                        </h3>
                        
                        <!-- Mode Selector -->
                        <div class="mode-selector">
                            <button class="mode-btn active" data-type="lead" data-mode="file">
                                <i class="fas fa-file-upload"></i> File
                            </button>
                            <button class="mode-btn" data-type="lead" data-mode="url">
                                <i class="fas fa-link"></i> URL
                            </button>
                            <span class="help-icon" data-type="lead" title="Come ottenere l'URL?">
                                <i class="fas fa-question-circle"></i>
                            </span>
                        </div>
                        
                        <!-- File Mode -->
                        <div class="upload-mode file-mode" data-type="lead">
                            <div id="leadDropZone" class="file-upload-area rounded-lg p-6 text-center cursor-pointer min-h-[120px] flex flex-col justify-center">
                                <i class="fas fa-file-csv fa-users text-4xl text-gray-400 mb-3"></i>
                                <p class="text-sm text-gray-600 font-medium">Trascina qui o clicca</p>
                                <p class="text-xs text-gray-500 mt-1">Dati principali del funnel CRM</p>
                            </div>
                            <input type="file" id="leadFile" accept=".csv" style="display: none;">
                        </div>
                        
                        <!-- URL Mode -->
                        <div class="upload-mode url-mode hidden" data-type="lead">
                            <div class="url-input-container">
                                <div class="url-input-wrapper">
                                    <input type="text" class="url-input" id="leadURL" placeholder="https://docs.google.com/spreadsheets/d/e/.../pub?gid=...&single=true&output=csv">
                                    <button class="save-url-btn" data-type="lead"><i class="fas fa-save mr-1"></i>Salva</button>
                                </div>
                                <button class="load-url-btn" data-type="lead">
                                    <i class="fas fa-download"></i> Carica da URL
                                </button>
                                <div class="url-status" id="leadUrlStatus"></div>
                                <div class="url-tutorial" data-type="lead">
                                    <strong>üìã Come ottenere l'URL corretto:</strong>
                                    <ol>
                                        <li>Apri il tuo Google Sheet</li>
                                        <li>Menu: <strong>File ‚Üí Condividi ‚Üí Pubblica sul Web</strong></li>
                                        <li>Nella finestra che si apre:
                                            <ul style="margin-left: 1rem; margin-top: 0.5rem;">
                                                <li>Seleziona: Il <strong>foglio specifico</strong> (es: "Lead", NON "Intero documento")</li>
                                                <li>Formato: Scegli <strong>"Valori separati da virgola (.csv)"</strong></li>
                                            </ul>
                                        </li>
                                        <li>Clicca <strong>"Pubblica"</strong></li>
                                        <li>Copia l'URL generato</li>
                                    </ol>
                                    <div style="margin-top: 0.75rem; padding: 0.5rem; background: #fef3c7; border-radius: 4px;">
                                        <strong>‚úÖ Esempio URL corretto:</strong><br>
                                        <code style="font-size: 0.65rem;">https://docs.google.com/spreadsheets/d/e/2PACX.../pub?gid=1192644605&single=true&output=csv</code>
                                    </div>
                                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #78350f;">
                                        üí° <strong>Nota:</strong> Usiamo proxy CORS multipli per massima affidabilit√†.
                                    </div>
                                    <div style="margin-top: 0.75rem; padding: 0.5rem; background: #e0f2fe; border: 1px solid #7dd3fc; border-radius: 4px; font-size: 0.75rem;">
                                        <strong>üîß Se il caricamento fallisce:</strong><br>
                                        1. Apri l'URL del foglio nel browser<br>
                                        2. Salva il file CSV sul computer (Ctrl+S / Cmd+S)<br>
                                        3. Torna qui e carica il file salvato usando il pulsante "File"
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="leadStatus" class="mt-3 text-xs hidden"></div>
                    </div>


                    <!-- Report Campagne -->
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                        <h3 class="font-semibold text-blue-800 mb-3">
                            <i class="fas fa-bullhorn mr-2"></i>Report Campagne
                            <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full ml-2">Obbligatorio</span>
                        </h3>
                        
                        <!-- Mode Selector -->
                        <div class="mode-selector">
                            <button class="mode-btn active" data-type="campaigns" data-mode="file">
                                <i class="fas fa-file-upload"></i> File
                            </button>
                            <button class="mode-btn" data-type="campaigns" data-mode="url">
                                <i class="fas fa-link"></i> URL
                            </button>
                            <span class="help-icon" data-type="campaigns" title="Come ottenere l'URL?">
                                <i class="fas fa-question-circle"></i>
                            </span>
                        </div>
                        
                        <!-- File Mode -->
                        <div class="upload-mode file-mode" data-type="campaigns">
                            <div id="campaignsDropZone" class="file-upload-area rounded-lg p-6 text-center cursor-pointer min-h-[120px] flex flex-col justify-center">
                                <i class="fas fa-file-csv fa-bullhorn text-4xl text-gray-400 mb-3"></i>
                                <p class="text-sm text-gray-600 font-medium">Trascina qui o clicca</p>
                                <p class="text-xs text-gray-500 mt-1">Spesa pubblicitaria e metriche</p>
                            </div>
                            <input type="file" id="campaignsFile" accept=".csv" style="display: none;">
                        </div>
                        
                        <!-- URL Mode -->
                        <div class="upload-mode url-mode hidden" data-type="campaigns">
                            <div class="url-input-container">
                                <div class="url-input-wrapper">
                                    <input type="text" class="url-input" id="campaignsURL" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
                                    <button class="save-url-btn" data-type="campaigns"><i class="fas fa-save mr-1"></i>Salva</button>
                                </div>
                                <button class="load-url-btn" data-type="campaigns">
                                    <i class="fas fa-download"></i> Carica da URL
                                </button>
                                <div class="url-status" id="campaignsUrlStatus"></div>
                                <div class="url-tutorial" data-type="campaigns">
                                    <strong>üìã Come ottenere l'URL corretto:</strong>
                                    <ol>
                                        <li>Apri il tuo Google Sheet</li>
                                        <li>Menu: <strong>File ‚Üí Condividi ‚Üí Pubblica sul Web</strong></li>
                                        <li>Nella finestra che si apre:
                                            <ul style="margin-left: 1rem; margin-top: 0.5rem;">
                                                <li>Seleziona il <strong>foglio specifico</strong> (es: "Report Campagne")</li>
                                                <li>Formato: Scegli <strong>"Valori separati da virgola (.csv)"</strong></li>
                                            </ul>
                                        </li>
                                        <li>Clicca <strong>"Pubblica"</strong></li>
                                        <li>Copia l'URL generato</li>
                                    </ol>
                                    <div style="margin-top: 0.75rem; padding: 0.5rem; background: #fef3c7; border-radius: 4px;">
                                        <strong>‚úÖ Esempio URL corretto:</strong><br>
                                        <code style="font-size: 0.65rem;">https://docs.google.com/spreadsheets/d/ABC123.../pub?output=csv</code>
                                    </div>
                                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #78350f;">
                                        üí° <strong>Nota:</strong> Usiamo proxy CORS multipli per massima affidabilit√†.
                                    </div>
                                    <div style="margin-top: 0.75rem; padding: 0.5rem; background: #e0f2fe; border: 1px solid #7dd3fc; border-radius: 4px; font-size: 0.75rem;">
                                        <strong>üîß Se il caricamento fallisce:</strong><br>
                                        1. Apri l'URL del foglio nel browser<br>
                                        2. Salva il file CSV sul computer (Ctrl+S / Cmd+S)<br>
                                        3. Torna qui e carica il file salvato usando il pulsante "File"
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="campaignsStatus" class="mt-3 text-xs hidden"></div>
                    </div>


                    <!-- Report Vendite -->
                    <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-4">
                        <h3 class="font-semibold text-gray-700 mb-3">
                            <i class="fas fa-euro-sign mr-2"></i>Report Vendite
                            <span class="bg-gray-400 text-white text-xs px-2 py-1 rounded-full ml-2">Opzionale</span>
                        </h3>
                        
                        <!-- Mode Selector -->
                        <div class="mode-selector">
                            <button class="mode-btn active" data-type="sales" data-mode="file">
                                <i class="fas fa-file-upload"></i> File
                            </button>
                            <button class="mode-btn" data-type="sales" data-mode="url">
                                <i class="fas fa-link"></i> URL
                            </button>
                            <span class="help-icon" data-type="sales" title="Come ottenere l'URL?">
                                <i class="fas fa-question-circle"></i>
                            </span>
                        </div>
                        
                        <!-- File Mode -->
                        <div class="upload-mode file-mode" data-type="sales">
                            <div id="salesDropZone" class="file-upload-area rounded-lg p-6 text-center cursor-pointer min-h-[120px] flex flex-col justify-center">
                                <i class="fas fa-file-csv fa-euro-sign text-4xl text-gray-400 mb-3"></i>
                                <p class="text-sm text-gray-600 font-medium">Trascina qui o clicca</p>
                                <p class="text-xs text-gray-500 mt-1">Fatturato e validazione vendite</p>
                            </div>
                            <input type="file" id="salesFile" accept=".csv" style="display: none;">
                        </div>
                        
                        <!-- URL Mode -->
                        <div class="upload-mode url-mode hidden" data-type="sales">
                            <div class="url-input-container">
                                <div class="url-input-wrapper">
                                    <input type="text" class="url-input" id="salesURL" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
                                    <button class="save-url-btn" data-type="sales"><i class="fas fa-save mr-1"></i>Salva</button>
                                </div>
                                <button class="load-url-btn" data-type="sales">
                                    <i class="fas fa-download"></i> Carica da URL
                                </button>
                                <div class="url-status" id="salesUrlStatus"></div>
                                <div class="url-tutorial" data-type="sales">
                                    <strong>üìã Come ottenere l'URL corretto:</strong>
                                    <ol>
                                        <li>Apri il tuo Google Sheet</li>
                                        <li>Menu: <strong>File ‚Üí Condividi ‚Üí Pubblica sul Web</strong></li>
                                        <li>Nella finestra che si apre:
                                            <ul style="margin-left: 1rem; margin-top: 0.5rem;">
                                                <li>Seleziona il <strong>foglio specifico</strong> (es: "Report Vendite")</li>
                                                <li>Formato: Scegli <strong>"Valori separati da virgola (.csv)"</strong></li>
                                            </ul>
                                        </li>
                                        <li>Clicca <strong>"Pubblica"</strong></li>
                                        <li>Copia l'URL generato</li>
                                    </ol>
                                    <div style="margin-top: 0.75rem; padding: 0.5rem; background: #fef3c7; border-radius: 4px;">
                                        <strong>‚úÖ Esempio URL corretto:</strong><br>
                                        <code style="font-size: 0.65rem;">https://docs.google.com/spreadsheets/d/ABC123.../pub?output=csv</code>
                                    </div>
                                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #78350f;">
                                        üí° <strong>Nota:</strong> Usiamo proxy CORS multipli per massima affidabilit√†.
                                    </div>
                                    <div style="margin-top: 0.75rem; padding: 0.5rem; background: #e0f2fe; border: 1px solid #7dd3fc; border-radius: 4px; font-size: 0.75rem;">
                                        <strong>üîß Se il caricamento fallisce:</strong><br>
                                        1. Apri l'URL del foglio nel browser<br>
                                        2. Salva il file CSV sul computer (Ctrl+S / Cmd+S)<br>
                                        3. Torna qui e carica il file salvato usando il pulsante "File"
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="salesStatus" class="mt-3 text-xs hidden"></div>
                    </div>


                    <!-- Report Settimanale -->
                    <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-4">
                        <h3 class="font-semibold text-gray-700 mb-3">
                            <i class="fas fa-calendar-week mr-2"></i>Report Settimanale
                            <span class="bg-gray-400 text-white text-xs px-2 py-1 rounded-full ml-2">Opzionale</span>
                        </h3>
                        
                        <!-- Mode Selector -->
                        <div class="mode-selector">
                            <button class="mode-btn active" data-type="weekly" data-mode="file">
                                <i class="fas fa-file-upload"></i> File
                            </button>
                            <button class="mode-btn" data-type="weekly" data-mode="url">
                                <i class="fas fa-link"></i> URL
                            </button>
                            <span class="help-icon" data-type="weekly" title="Come ottenere l'URL?">
                                <i class="fas fa-question-circle"></i>
                            </span>
                        </div>
                        
                        <!-- File Mode -->
                        <div class="upload-mode file-mode" data-type="weekly">
                            <div id="weeklyDropZone" class="file-upload-area rounded-lg p-6 text-center cursor-pointer min-h-[120px] flex flex-col justify-center">
                                <i class="fas fa-file-csv fa-calendar-week text-4xl text-gray-400 mb-3"></i>
                                <p class="text-sm text-gray-600 font-medium">Trascina qui o clicca</p>
                                <p class="text-xs text-gray-500 mt-1">Trend e analisi temporali</p>
                            </div>
                            <input type="file" id="weeklyFile" accept=".csv" style="display: none;">
                        </div>
                        
                        <!-- URL Mode -->
                        <div class="upload-mode url-mode hidden" data-type="weekly">
                            <div class="url-input-container">
                                <div class="url-input-wrapper">
                                    <input type="text" class="url-input" id="weeklyURL" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
                                    <button class="save-url-btn" data-type="weekly"><i class="fas fa-save mr-1"></i>Salva</button>
                                </div>
                                <button class="load-url-btn" data-type="weekly">
                                    <i class="fas fa-download"></i> Carica da URL
                                </button>
                                <div class="url-status" id="weeklyUrlStatus"></div>
                                <div class="url-tutorial" data-type="weekly">
                                    <strong>üìã Come ottenere l'URL corretto:</strong>
                                    <ol>
                                        <li>Apri il tuo Google Sheet</li>
                                        <li>Menu: <strong>File ‚Üí Condividi ‚Üí Pubblica sul Web</strong></li>
                                        <li>Nella finestra che si apre:
                                            <ul style="margin-left: 1rem; margin-top: 0.5rem;">
                                                <li>Seleziona il <strong>foglio specifico</strong> (es: "Report Settimanale")</li>
                                                <li>Formato: Scegli <strong>"Valori separati da virgola (.csv)"</strong></li>
                                            </ul>
                                        </li>
                                        <li>Clicca <strong>"Pubblica"</strong></li>
                                        <li>Copia l'URL generato</li>
                                    </ol>
                                    <div style="margin-top: 0.75rem; padding: 0.5rem; background: #fef3c7; border-radius: 4px;">
                                        <strong>‚úÖ Esempio URL corretto:</strong><br>
                                        <code style="font-size: 0.65rem;">https://docs.google.com/spreadsheets/d/ABC123.../pub?output=csv</code>
                                    </div>
                                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #78350f;">
                                        üí° <strong>Nota:</strong> Usiamo proxy CORS multipli per massima affidabilit√†.
                                    </div>
                                    <div style="margin-top: 0.75rem; padding: 0.5rem; background: #e0f2fe; border: 1px solid #7dd3fc; border-radius: 4px; font-size: 0.75rem;">
                                        <strong>üîß Se il caricamento fallisce:</strong><br>
                                        1. Apri l'URL del foglio nel browser<br>
                                        2. Salva il file CSV sul computer (Ctrl+S / Cmd+S)<br>
                                        3. Torna qui e carica il file salvato usando il pulsante "File"
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="weeklyStatus" class="mt-3 text-xs hidden"></div>
                    </div>

                </div>

                <!-- Pulsante Elabora -->
                <div class="mt-8 text-center">
                    <button id="processButton" disabled class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-4 rounded-xl font-semibold text-lg disabled:opacity-50 disabled:cursor-not-allowed hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105 shadow-lg">
                        üöÄ Elabora Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- SEZIONE FILTRI -->
        <div class="mb-8" id="filtersSection" style="display: none;">
            <div class="gradient-bg text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold flex items-center text-purple-200">
                        <i class="fas fa-filter mr-3 text-2xl text-purple-200"></i>
                        üéõÔ∏è Filtri per l'Analisi
                    </h2>
                    <div class="flex items-center space-x-2">
                        <span id="filtersActiveIndicator" class="text-sm text-purple-200 hidden">
                            <i class="fas fa-check-circle text-green-300 mr-1"></i>
                            <span id="filtersActiveCount">0</span> filtri attivi
                        </span>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-6">
                    <div class="relative">
                        <label class="block text-sm font-semibold text-purple-200 mb-2">
                            <i class="fas fa-calendar text-blue-300 mr-1"></i>Periodo
                        </label>
                        <select id="filterPeriodo" class="filter-select text-gray-800">
                            <option value="tutto">Tutto</option>
                            <option value="7">Ultimi 7 giorni</option>
                            <option value="14">Ultimi 14 giorni</option>
                            <option value="30">Ultimi 30 giorni</option>
                            <option value="90">Ultimi 90 giorni</option>
                            <option value="custom">Personalizzato</option>
                        </select>
                        
                        <div id="customDateInputs" class="date-inputs-container">
                            <div>
                                <label class="block text-xs font-medium text-purple-200 mb-1">Data Inizio</label>
                                <input type="date" id="dateStart" class="date-input text-gray-800" placeholder="gg/mm/aaaa">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-purple-200 mb-1">Data Fine</label>
                                <input type="date" id="dateEnd" class="date-input text-gray-800" placeholder="gg/mm/aaaa">
                            </div>
                        </div>
                    </div>

                    <div class="relative">
                        <label class="block text-sm font-semibold text-purple-200 mb-2">
                            <i class="fas fa-globe text-green-300 mr-1"></i>Fonte
                        </label>
                        <select id="filterFonte" class="filter-select text-gray-800">
                            <option value="">Tutte le fonti</option>
                        </select>
                    </div>

                    <div class="relative">
                        <label class="block text-sm font-semibold text-purple-200 mb-2">
                            <i class="fas fa-bullhorn text-purple-300 mr-1"></i>Mezzo
                        </label>
                        <select id="filterMezzo" class="filter-select text-gray-800">
                            <option value="">Tutti i mezzi</option>
                        </select>
                    </div>

                    <div class="relative">
                        <label class="block text-sm font-semibold text-purple-200 mb-2">
                            <i class="fas fa-store text-cyan-300 mr-1"></i>Punto Vendita
                        </label>
                        <select id="filterPuntoVendita" class="filter-select text-gray-800">
                            <option value="">Tutti i punti vendita</option>
                            <option value="Seregno">Seregno</option>
                            <option value="Zanica">Zanica</option>
                        </select>
                    </div>

                    <div class="relative">
                        <label class="block text-sm font-semibold text-purple-200 mb-2">
                            <i class="fas fa-redo text-pink-300 mr-1"></i>Riattivazione
                        </label>
                        <select id="filterRiattivazione" class="filter-select text-gray-800">
                            <option value="">Tutte</option>
                            <option value="VERO">VERO</option>
                            <option value="FALSO">FALSO</option>
                        </select>
                    </div>

                    <div class="relative">
                        <label class="block text-sm font-semibold text-purple-200 mb-2">
                            <i class="fas fa-user-tag text-indigo-300 mr-1"></i>Person Type
                        </label>
                        <select id="filterPersonType" class="filter-select text-gray-800">
                            <option value="">Tutti i tipi</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-center space-x-4">
                    <button id="applyFilters" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg font-semibold flex items-center transition-all transform hover:scale-105 shadow-lg">
                        <i class="fas fa-check mr-2"></i>‚úÖ Applica Filtri
                    </button>
                    <button id="resetFilters" class="bg-gray-600 hover:bg-gray-700 text-white px-8 py-3 rounded-lg font-semibold flex items-center transition-all transform hover:scale-105 shadow-lg">
                        <i class="fas fa-undo mr-2"></i>üîÑ Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Content COMPLETA -->
        <div id="dashboardContent" class="hidden">
            <!-- KPI Funnel di Conversione -->
            <div id="funnelKpiSection" class="mb-8 fade-in">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                    <h2 class="text-2xl font-bold flex items-center text-gray-800">
                        <i class="fas fa-funnel-dollar text-blue-500 mr-3"></i>
                        üéØ Funnel di Conversione
                    </h2>
                    <button id="exportFunnelKpi" class="section-export-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold text-sm py-2 px-4 rounded-full shadow-sm" title="Esporta questa sezione in PDF">
                        <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                    <!-- Contatti Totali -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-users text-purple-500 text-3xl"></i>
                            <span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded-full font-medium">Totale</span>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800" id="kpiTotalContacts">0</h3>
                        <p class="text-gray-600 text-sm font-medium">Contatti Totali</p>
                    </div>
                    
                    <!-- Lead -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-user-check text-green-500 text-3xl"></i>
                            <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full font-medium">Lead</span>
                        </div>
                        <h3 class="text-3xl font-bold text-green-600" id="kpiLeads">0</h3>
                        <p class="text-gray-600 text-sm font-medium">Lead Qualificati</p>
                        <div class="mt-2">
                            <span class="text-xs text-gray-500 font-medium" id="kpiLeadsPerc">0%</span>
                        </div>
                    </div>
                    
                    <!-- Prospect -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-handshake text-blue-500 text-3xl"></i>
                            <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-medium">Prospect</span>
                        </div>
                        <h3 class="text-3xl font-bold text-blue-600" id="kpiProspects">0</h3>
                        <p class="text-gray-600 text-sm font-medium">Offerte Sviluppate</p>
                        <div class="mt-2">
                            <span class="text-xs text-gray-500 font-medium" id="kpiProspectsPerc">0%</span>
                        </div>
                    </div>
                    
                    <!-- Clienti -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-trophy text-pink-500 text-3xl"></i>
                            <span class="text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded-full font-medium">Clienti</span>
                        </div>
                        <h3 class="text-3xl font-bold text-pink-600" id="kpiClients">0</h3>
                        <p class="text-gray-600 text-sm font-medium">Vendite Chiuse</p>
                        <div class="mt-2">
                            <span class="text-xs text-gray-500 font-medium" id="kpiClientsPerc">0%</span>
                        </div>
                    </div>
                    
                    <!-- Ghost -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-ghost text-red-500 text-3xl"></i>
                            <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full font-medium">Ghost</span>
                        </div>
                        <h3 class="text-3xl font-bold text-red-600" id="kpiGhosts">0</h3>
                        <p class="text-gray-600 text-sm font-medium">Non Contattati</p>
                        <div class="mt-2">
                            <span class="text-xs text-gray-500 font-medium" id="kpiGhostsPerc">0%</span>
                        </div>
                    </div>
                    
                    <!-- Non Lavorati -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-clock text-orange-500 text-3xl"></i>
                            <span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full font-medium">Pending</span>
                        </div>
                        <h3 class="text-3xl font-bold text-orange-600" id="kpiNotWorked">0</h3>
                        <p class="text-gray-600 text-sm font-medium">Non Lavorati</p>
                        <div class="mt-2">
                            <span class="text-xs text-gray-500 font-medium" id="kpiNotWorkedPerc">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Performance Economica -->
            <div id="economicKpiSection" class="mb-8 fade-in">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                    <h2 class="text-2xl font-bold flex items-center text-gray-800">
                        <i class="fas fa-chart-line text-green-500 mr-3"></i>
                        üí∞ Performance Economica
                    </h2>
                    <button id="exportEconomicKpi" class="section-export-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold text-sm py-2 px-4 rounded-full shadow-sm" title="Esporta questa sezione in PDF">
                        <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Valore Venduto Card -->
                    <div class="bg-gradient-to-r from-green-400 to-blue-500 rounded-xl shadow-lg p-6 text-white col-span-1 md:col-span-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm mb-2 font-medium">Valore Totale Venduto</p>
                                <h2 class="text-4xl font-bold" id="kpiTotalValue">‚Ç¨ 0</h2>
                            </div>
                            <div class="text-right">
                                <p class="text-green-100 text-sm mb-2 font-medium">Valore Medio Vendita (AOV)</p>
                                <h3 class="text-2xl font-semibold" id="kpiAvgValue">‚Ç¨ 0</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Efficienza Pubblicitaria -->
            <div id="advertisingKpiSection" class="mb-8 fade-in">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                    <h2 class="text-2xl font-bold flex items-center text-gray-800">
                        <i class="fas fa-bullseye text-red-500 mr-3"></i>
                        üìä Efficienza Pubblicitaria
                    </h2>
                    <button id="exportAdvertisingKpi" class="section-export-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold text-sm py-2 px-4 rounded-full shadow-sm" title="Esporta questa sezione in PDF">
                        <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-4">
                    <!-- Spesa Pubblicitaria -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-euro-sign text-blue-500 text-3xl"></i>
                            <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-medium">Spesa</span>
                        </div>
                        <h3 class="text-2xl font-bold text-blue-600" id="kpiAdSpend">‚Ç¨ 0</h3>
                        <p class="text-gray-600 text-sm font-medium">Spesa Pubblicitaria</p>
                    </div>
                    
                    <!-- ROI -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-percentage text-green-500 text-3xl"></i>
                            <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full font-medium">ROI</span>
                        </div>
                        <h3 class="text-2xl font-bold" id="kpiROI">0X</h3>
                        <p class="text-gray-600 text-sm font-medium">Return on Investment</p>
                    </div>

                    <!-- Valore del Contatto (NUOVA CARD) -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-dollar-sign text-purple-500 text-3xl"></i>
                            <span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded-full font-medium">Valore</span>
                        </div>
                        <h3 class="text-2xl font-bold text-purple-600" id="kpiContactValue">‚Ç¨ 0</h3>
                        <p class="text-gray-600 text-sm font-medium">Valore del Contatto</p>
                    </div>
                    
                    <!-- CPC -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-mouse-pointer text-orange-500 text-3xl"></i>
                            <span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full font-medium">CPC</span>
                        </div>
                        <h3 class="text-2xl font-bold text-orange-600" id="kpiCPC">‚Ç¨ 0</h3>
                        <p class="text-gray-600 text-sm font-medium">Costo per Contatto</p>
                    </div>
                    
                    <!-- CPL -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-user-check text-yellow-500 text-3xl"></i>
                            <span class="text-xs bg-yellow-100 text-yellow-600 px-2 py-1 rounded-full font-medium">CPL</span>
                        </div>
                        <h3 class="text-2xl font-bold text-yellow-600" id="kpiCPL">‚Ç¨ 0</h3>
                        <p class="text-gray-600 text-sm font-medium">Costo per Lead</p>
                    </div>

                    <!-- CPO -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-file-signature text-indigo-500 text-3xl"></i>
                            <span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full font-medium">CPO</span>
                        </div>
                        <h3 class="text-2xl font-bold text-indigo-600" id="kpiCPO">‚Ç¨ 0</h3>
                        <p class="text-gray-600 text-sm font-medium">Costo per Offerta</p>
                    </div>
                    
                    <!-- CPV -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-eye text-pink-500 text-3xl"></i>
                            <span class="text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded-full font-medium">CPV</span>
                        </div>
                        <h3 class="text-2xl font-bold text-pink-600" id="kpiCPV">‚Ç¨ 0</h3>
                        <p class="text-gray-600 text-sm font-medium">Costo per Vendita</p>
                    </div>
                </div>
            </div>

            <!-- CHARTS ROW -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 fade-in">
                <!-- Funnel Chart -->
                <div id="funnelChartSection" class="bg-white rounded-xl shadow-lg border border-gray-100">
                    <div class="gradient-bg text-white p-4 rounded-t-xl flex justify-between items-center">
                        <h3 class="text-xl font-bold">üìà Funnel di Conversione</h3>
                        <button id="exportFunnelChart" class="section-export-btn bg-white/20 hover:bg-white/30 text-white font-semibold text-sm py-1 px-3 rounded-full" title="Esporta grafico in PDF">
                            <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                        </button>
                    </div>
                    <div class="p-6" style="height: 350px;">
                        <canvas id="funnelChart"></canvas>
                    </div>
                </div>
                
                <!-- Card Tassi Conversione -->
                <div id="conversionChartSection" class="bg-white rounded-xl shadow-lg border border-gray-100">
                    <div class="gradient-bg text-white p-4 rounded-t-xl flex justify-between items-center">
                        <h3 class="text-xl font-bold flex items-center">
                            üìä Dispersioni e Tassi di Conversione
                        </h3>
                        <button id="drillDownBtn" class="text-sm bg-white/20 text-white px-3 py-1 rounded-full hover:bg-white/30 transition-colors">
                            <i class="fas fa-search-plus mr-1"></i>
                            Analisi Dettagliata
                        </button>
                    </div>
                    <div class="p-6 chart-clickable" style="height: 350px;">
                        <canvas id="conversionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- INIZIO NUOVA SEZIONE EFFICIENZA -->
            <div id="efficiencySection" class="mb-8 fade-in">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                    <h2 class="text-2xl font-bold flex items-center text-gray-800">
                        üî¨ Indici di Efficienza del Funnel
                    </h2>
                    <button id="exportEfficiency" class="section-export-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold text-sm py-2 px-4 rounded-full shadow-sm" title="Esporta questa sezione in PDF">
                        <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                    </button>
                </div>
        
                <!-- Sottosezione Rapporti di Sforzo -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 ml-1">Rapporti di Sforzo</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        
                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Contatti / Offerta</p>
                                <i class="fas fa-users text-blue-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-blue-600" id="effContattiPerOfferta">0</p>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Lead / Offerta</p>
                                <i class="fas fa-user-check text-blue-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-blue-600" id="effLeadPerOfferta">0</p>
                        </div>
        
                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Contatti / Vendita</p>
                                <i class="fas fa-users text-green-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-green-600" id="effContattiPerVendita">0</p>
                        </div>
        
                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Lead / Vendita</p>
                                <i class="fas fa-user-check text-green-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-green-600" id="effLeadPerVendita">0</p>
                        </div>
        
                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Offerte / Vendita</p>
                                <i class="fas fa-handshake text-pink-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-pink-600" id="effOffertePerVendita">0</p>
                        </div>
                    </div>
                </div>
        
                <!-- Sottosezione Tassi di Conversione -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 ml-1">Tassi di Conversione Diretti</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
        
                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Offerte / Contatti (O/C)</p>
                                <i class="fas fa-percentage text-blue-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-blue-600" id="effRateOC">0.0%</p>
                        </div>
        
                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Offerte / Lead (O/L)</p>
                                <i class="fas fa-percentage text-blue-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-blue-600" id="effRateOL">0.0%</p>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Vendite / Contatti (V/C)</p>
                                <i class="fas fa-percentage text-green-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-green-600" id="effRateVC">0.0%</p>
                        </div>
        
                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Vendite / Lead (V/L)</p>
                                <i class="fas fa-percentage text-green-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-green-600" id="effRateVL">0.0%</p>
                        </div>
        
                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Vendite / Offerte (V/O)</p>
                                <i class="fas fa-percentage text-pink-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-pink-600" id="effRateVO">0.0%</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- FINE NUOVA SEZIONE EFFICIENZA -->

            <!-- INIZIO NUOVA SEZIONE ANALISI TEMPORALE -->
            <div id="temporalAnalysisSection" class="mb-8 fade-in">
                <div class="bg-white rounded-xl shadow-lg border border-gray-100">
                    <div class="gradient-bg text-white p-4 rounded-t-xl flex justify-between items-center flex-wrap gap-4">
                        <h3 class="text-xl font-bold flex items-center">
                            üìà Andamento del Funnel
                        </h3>
                        <div class="flex items-center space-x-4">
                            <div class="bg-white/20 p-1 rounded-lg flex items-center space-x-1">
                                <button id="aggWeekly" class="agg-btn active">Settimanale</button>
                                <button id="aggMonthly" class="agg-btn">Mensile</button>
                                <button id="aggAnnual" class="agg-btn">Annuale</button>
                            </div>
                            <button id="exportTemporalFunnel" class="section-export-btn bg-white/20 hover:bg-white/30 text-white font-semibold text-sm py-1 px-3 rounded-full" title="Esporta grafico in PDF">
                                <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="temporalFunnelChartContainer" style="height: 400px;">
                            <canvas id="temporalFunnelChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="temporalEconomicAnalysisSection" class="mb-8 fade-in">
                <div class="bg-white rounded-xl shadow-lg border border-gray-100">
                    <div class="gradient-bg text-white p-4 rounded-t-xl flex justify-between items-center flex-wrap gap-4">
                        <h3 class="text-xl font-bold flex items-center">
                            üí∞ Andamento Economico
                        </h3>
                        <div class="flex items-center space-x-4">
                            <div class="bg-white/20 p-1 rounded-lg flex items-center space-x-1">
                                <button id="aggMonthlyEco" class="agg-btn active">Mensile</button>
                                <button id="aggAnnualEco" class="agg-btn">Annuale</button>
                            </div>
                            <button id="exportTemporalEconomic" class="section-export-btn bg-white/20 hover:bg-white/30 text-white font-semibold text-sm py-1 px-3 rounded-full" title="Esporta grafico in PDF">
                                <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="temporalEconomicChartContainer" style="height: 400px;">
                            <canvas id="temporalEconomicChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- FINE NUOVA SEZIONE ANALISI TEMPORALE -->

            <!-- CHART A BOLLE PERFORMANCE PER FONTE -->
            <div id="performanceChartSection" class="mb-8 fade-in">
                <div class="bg-white rounded-xl shadow-lg border border-gray-100">
                    <div class="gradient-bg text-white p-4 rounded-t-xl flex justify-between items-center">
                        <h3 class="text-xl font-bold flex items-center">
                            üíé Performance per Fonte - Valore vs Efficienza
                        </h3>
                        <button id="performanceDrillDownBtn" class="text-sm bg-white/20 text-white px-3 py-1 rounded-full hover:bg-white/30 transition-colors">
                            <i class="fas fa-search-plus mr-1"></i>
                            Analisi Dettagliata
                        </button>
                    </div>
                    <div class="p-6 chart-clickable" style="height: 450px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                    <div class="p-6 pt-0 text-sm text-gray-600">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                                <span><strong>Asse X:</strong> Volume Contatti</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                <span><strong>Asse Y:</strong> Tasso Conversione %</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-purple-500 rounded-full mr-2"></div>
                                <span><strong>Dimensione:</strong> Fatturato Totale</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABELLA PERFORMANCE -->
            <div id="performanceTableSection" class="mb-8 fade-in">
                <div class="bg-white rounded-xl shadow-lg border border-gray-100">
                    <div class="gradient-bg text-white p-6 flex items-center justify-between rounded-t-xl">
                        <div class="flex items-center">
                            <h2 class="text-xl font-bold">üìä Performance Dettagliata per Fonte</h2>
                        </div>
                        <div class="flex space-x-3">
                            <button id="exportCSV" class="export-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center shadow-sm">
                                <i class="fas fa-file-csv mr-2"></i>
                                Esporta CSV
                            </button>
                            <button id="exportPDF" class="export-btn bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center shadow-sm">
                                <i class="fas fa-file-pdf mr-2"></i>
                                Esporta PDF
                            </button>
                        </div>
                    </div>
                    
                    <div id="performanceTableContainer" class="p-6">
                        <!-- Tabella generata dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Insights Strategici -->
            <div id="insightsPanel" class="mb-8 fade-in">
                <div class="bg-gradient-to-r from-purple-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        üß† Insights Strategici
                    </h2>
                    <div id="insightsContent" class="space-y-4">
                        <!-- Dinamico -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Il codice JavaScript √® identico alla versione precedente (v29)
        // Le modifiche sono solo nel markup HTML e nelle classi CSS
        
        const CONFIG = {
            DEBUG_MODE: false,
            MAX_DEBUG_ENTRIES: 100,
            GENERIC_CHART_COLORS: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#f97316', '#84cc16', '#ec4899', '#6b7280'],
            CHART_COLORS: {
                contatti: 'rgba(139, 90, 43, 0.8)',
                lead: 'rgba(34, 197, 94, 0.8)',
                prospect: 'rgba(59, 130, 246, 0.8)',
                clienti: 'rgba(236, 72, 153, 0.8)',
                spesa: 'rgba(59, 130, 246, 0.6)',
                fatturato: 'rgba(16, 185, 129, 0.6)',
                vendite: 'rgba(139, 92, 246, 1)',
                roi: 'rgba(249, 115, 22, 1)'
            },
            PERFORMANCE_THRESHOLDS: {
                CRITICAL: 5, LOW: 10, MEDIUM: 15, GOOD: 25
            },
            GHOST_THRESHOLDS: {
                EXCELLENT: 10, WARNING: 20
            }
        };

        class DashboardApp {
            constructor() {
                this.data = {
                    raw: { lead: null, campaigns: null, sales: null, weekly: null },
                    original: { lead: null, campaigns: null },
                    filtered: {
                        leadByPeriod: null, leadFullyFiltered: null, campaigns: null
                    },
                    processed: { 
                        funnel: {}, economic: {}, advertising: {}, performance: {}, 
                        conversionRates: {}, performanceBubbles: {}, efficiency: {}, temporal: {} 
                    }
                };
                this.filters = {
                    state: { 
                        periodo: 'tutto', dateStart: null, dateEnd: null, fonte: '', mezzo: '', 
                        puntoVendita: '', riattivazione: '', personType: '', active: false 
                    },
                    options: { 
                        fonti: new Set(), mezzi: new Set(), personTypes: new Set() 
                    }
                };
                this.charts = {};
                this.logger = new Logger();
                this.dateTimeInterval = null;
                this.currentFunnelAggregation = 'weekly'; 
                this.currentEconomicAggregation = 'monthly';
            }

            init() {
                this.logger.log('üöÄ Inizializzazione Dashboard Intelligence 3.0', 'success');
                this.setupEventListeners();
                this.fileManager = new FileManager(this);
                this.filterManager = new FilterManager(this);
                this.dataProcessor = new DataProcessor(this);
                this.chartRenderer = new ChartRenderer(this);
                this.tableRenderer = new TableRenderer(this);
                this.startDateTime();
            }

            setupEventListeners() {
                document.getElementById('toggleDebug')?.addEventListener('click', () => this.toggleDebug());
                document.getElementById('processButton')?.addEventListener('click', () => this.processData());
                document.getElementById('applyFilters')?.addEventListener('click', () => this.filterManager.apply());
                document.getElementById('resetFilters')?.addEventListener('click', () => this.filterManager.reset());
                document.getElementById('exportCSV')?.addEventListener('click', () => this.exportCSV());
                
                document.getElementById('exportFullDashboard')?.addEventListener('click', () => this.exportFullDashboardPDF());
                
                document.getElementById('exportPDF')?.addEventListener('click', () => 
                    this.exportSectionToPDF('performanceTableSection', 'performance_dettagliata')
                );
                
                document.getElementById('exportFunnelKpi')?.addEventListener('click', () => 
                    this.exportSectionToPDF('funnelKpiSection', 'funnel_kpi')
                );
                document.getElementById('exportEconomicKpi')?.addEventListener('click', () => 
                    this.exportSectionToPDF('economicKpiSection', 'performance_economica')
                );
                document.getElementById('exportAdvertisingKpi')?.addEventListener('click', () => 
                    this.exportSectionToPDF('advertisingKpiSection', 'efficienza_pubblicitaria')
                );
                document.getElementById('exportFunnelChart')?.addEventListener('click', () => 
                    this.exportSectionToPDF('funnelChartSection', 'grafico_funnel')
                );
                document.getElementById('exportEfficiency')?.addEventListener('click', () => 
                    this.exportSectionToPDF('efficiencySection', 'indici_efficienza')
                );
                document.getElementById('exportTemporalFunnel')?.addEventListener('click', () => 
                    this.exportSectionToPDF('temporalAnalysisSection', 'andamento_funnel')
                );
                document.getElementById('exportTemporalEconomic')?.addEventListener('click', () => 
                    this.exportSectionToPDF('temporalEconomicAnalysisSection', 'andamento_economico')
                );

                this.setupModalHandlers();
                this.setupAggregationHandlers();
            }

            setupAggregationHandlers() {
                const funnelButtons = {
                    weekly: document.getElementById('aggWeekly'),
                    monthly: document.getElementById('aggMonthly'),
                    annual: document.getElementById('aggAnnual')
                };
                Object.entries(funnelButtons).forEach(([agg, btn]) => {
                    btn?.addEventListener('click', () => {
                        if (this.currentFunnelAggregation === agg) return;
                        this.currentFunnelAggregation = agg;
                        Object.values(funnelButtons).forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.chartRenderer.renderTemporalFunnelChart();
                    });
                });

                const economicButtons = {
                    monthly: document.getElementById('aggMonthlyEco'),
                    annual: document.getElementById('aggAnnualEco')
                };
                Object.entries(economicButtons).forEach(([agg, btn]) => {
                    btn?.addEventListener('click', () => {
                        if (this.currentEconomicAggregation === agg) return;
                        this.currentEconomicAggregation = agg;
                        Object.values(economicButtons).forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.chartRenderer.renderTemporalEconomicChart();
                    });
                });
            }
            
            startDateTime() {
                const update = () => {
                    const now = new Date();
                    const date = now.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const time = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    document.getElementById('dateTimeValue').textContent = `${date}, ${time}`;
                };
                update();
                this.dateTimeInterval = setInterval(update, 60000);
            }

            setupModalHandlers() {
                const modalBindings = [
                    { btn: 'drillDownBtn', close: 'closeModal', modal: 'drillDownModal', open: () => this.openDrillDownModal() },
                    { btn: 'performanceDrillDownBtn', close: 'closePerformanceModal', modal: 'performanceModal', open: () => this.openPerformanceModal() }
                ];

                modalBindings.forEach(({ btn, close, modal, open }) => {
                    document.getElementById(btn)?.addEventListener('click', open);
                    document.getElementById(close)?.addEventListener('click', () => this.closeModal(modal));
                    document.getElementById(modal)?.addEventListener('click', (e) => {
                        if (e.target.id === modal) this.closeModal(modal);
                    });
                });
            }

            toggleDebug() {
                CONFIG.DEBUG_MODE = !CONFIG.DEBUG_MODE;
                document.getElementById('debugPanel').style.display = CONFIG.DEBUG_MODE ? 'block' : 'none';
                this.logger.log(`Debug mode ${CONFIG.DEBUG_MODE ? 'attivato' : 'disattivato'}`, 'info');
            }

            processData() {
                try {
                    this.logger.log('üìä Inizio elaborazione dati', 'success');
                    this.data.filtered.leadByPeriod = JSON.parse(JSON.stringify(this.data.original.lead));
                    this.data.filtered.leadFullyFiltered = JSON.parse(JSON.stringify(this.data.original.lead));
                    this.data.filtered.campaigns = JSON.parse(JSON.stringify(this.data.original.campaigns));
                    const leadData = this.dataProcessor.processLead(this.data.filtered.leadFullyFiltered);
                    const campaignData = this.dataProcessor.processCampaigns(this.data.filtered.campaigns);
                    this.dataProcessor.calculateMetrics(leadData, campaignData);
                    this.filterManager.populate();
                    this.render();
                    this.showFilters();
                    this.updateStatus('Dashboard elaborata con successo', 'success');
                    document.getElementById('dateTimeDisplay').classList.remove('hidden');
                    
                    document.getElementById('exportFullDashboard').disabled = false;
                    
                    this.logger.log('‚úÖ Elaborazione completata', 'success');
                } catch (error) {
                    this.logger.log(`‚ùå Errore: ${error.message}`, 'error');
                    console.error('Stack trace:', error);
                    alert(`Errore durante l'elaborazione: ${error.message}`);
                }
            }

            render() {
                this.chartRenderer.renderAll();
                this.tableRenderer.render();
                this.renderKPIs();
                this.renderEfficiencyIndices(); 
                this.renderInsights();
                document.getElementById('dashboardContent')?.classList.remove('hidden');
            }

            renderKPIs() {
                const { funnel, economic, advertising } = this.data.processed;
                this.updateElement('kpiTotalContacts', funnel.contatti?.toLocaleString());
                this.updateElement('kpiLeads', funnel.lead?.toLocaleString());
                this.updateElement('kpiProspects', funnel.prospect?.toLocaleString());
                this.updateElement('kpiClients', funnel.clienti?.toLocaleString());
                this.updateElement('kpiGhosts', funnel.ghost?.toLocaleString());
                this.updateElement('kpiNotWorked', funnel.nonLavorati?.toLocaleString());
                if (funnel.contatti > 0) {
                    this.updateElement('kpiLeadsPerc', `${((funnel.lead / funnel.contatti) * 100).toFixed(1)}% dei contatti`);
                    this.updateElement('kpiProspectsPerc', `${funnel.lead > 0 ? ((funnel.prospect / funnel.lead) * 100).toFixed(1) : '0.0'}% dei lead`);
                    this.updateElement('kpiClientsPerc', `${funnel.prospect > 0 ? ((funnel.clienti / funnel.prospect) * 100).toFixed(1) : '0.0'}% dei prospect`);
                    this.updateElement('kpiGhostsPerc', `${((funnel.ghost / funnel.contatti) * 100).toFixed(1)}% del totale`);
                    this.updateElement('kpiNotWorkedPerc', `${((funnel.nonLavorati / funnel.contatti) * 100).toFixed(1)}% del totale`);
                }
                this.updateElement('kpiTotalValue', Utils.formatCurrency(economic.valoreVenduto));
                this.updateElement('kpiAvgValue', Utils.formatCurrency(economic.aov));
                this.updateElement('kpiAdSpend', Utils.formatCurrency(advertising.spesaTotale));
                this.updateElement('kpiROI', `${advertising.roi?.toFixed(2)}X`);
                this.updateElement('kpiContactValue', Utils.formatCurrency(advertising.valoreContatto)); 
                this.updateElement('kpiCPC', Utils.formatCurrency(advertising.cpcMedio));
                this.updateElement('kpiCPL', Utils.formatCurrency(advertising.cpl));
                this.updateElement('kpiCPO', Utils.formatCurrency(advertising.cpo));
                this.updateElement('kpiCPV', Utils.formatCurrency(advertising.cpvMedio));
                const roiElement = document.getElementById('kpiROI');
                if (roiElement) {
                    roiElement.className = `text-2xl font-bold ${advertising.roi > 15 ? 'text-green-600' : advertising.roi > 5 ? 'text-yellow-600' : 'text-red-600'}`;
                }
            }

            renderEfficiencyIndices() {
                const { efficiency } = this.data.processed;
                if (!efficiency) return;
                this.updateElement('effContattiPerOfferta', efficiency.contattiPerOfferta.toLocaleString());
                this.updateElement('effContattiPerVendita', efficiency.contattiPerVendita.toLocaleString());
                this.updateElement('effLeadPerOfferta', efficiency.leadPerOfferta.toLocaleString());
                this.updateElement('effLeadPerVendita', efficiency.leadPerVendita.toLocaleString());
                this.updateElement('effOffertePerVendita', efficiency.offertePerVendita.toLocaleString());
                this.updateElement('effRateOC', `${efficiency.rateOC.toFixed(1)}%`);
                this.updateElement('effRateVC', `${efficiency.rateVC.toFixed(1)}%`);
                this.updateElement('effRateOL', `${efficiency.rateOL.toFixed(1)}%`);
                this.updateElement('effRateVL', `${efficiency.rateVL.toFixed(1)}%`);
                this.updateElement('effRateVO', `${efficiency.rateVO.toFixed(1)}%`);
            }

            renderInsights() {
                const insightsHtml = new InsightsGenerator(this.data.processed).generate();
                const container = document.getElementById('insightsContent');
                if (container) {
                    container.innerHTML = insightsHtml.join('');
                }
            }

            showFilters() {
                document.getElementById('filtersSection').style.display = 'block';
            }

            updateStatus(message, type = 'info') {
                const status = document.getElementById('dataStatus');
                if (status) {
                    const colors = { success: 'bg-green-500/80', warning: 'bg-yellow-500/80', error: 'bg-red-500/80', info: 'bg-blue-500/80' };
                    status.innerHTML = `<i class="fas fa-circle text-white"></i> ${message}`;
                    status.className = `status-indicator ${colors[type]} px-3 py-1 rounded-full text-sm text-white`;
                }
            }

            updateElement(id, value) {
                const element = document.getElementById(id);
                if (element && value !== undefined && value !== null) {
                    element.textContent = value;
                }
            }

            openDrillDownModal() {
                new ModalRenderer(this).renderDrillDown();
                document.getElementById('drillDownModal').classList.remove('hidden');
            }

            openPerformanceModal() {
                new ModalRenderer(this).renderPerformance();
                document.getElementById('performanceModal').classList.remove('hidden');
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.add('hidden');
            }

            exportCSV() {
                try {
                    const exporter = new DataExporter(this.data.processed.performance);
                    exporter.toCSV('performance_dettagliata_per_fonte.csv');
                    this.app.logger.log('‚úÖ CSV esportato', 'success');
                } catch (error) {
                    this.app.logger.log(`‚ùå Errore export CSV: ${error.message}`, 'error');
                    alert('Errore durante l\'esportazione CSV');
                }
            }
            
            exportSectionToPDF(elementId, filename) {
                const buttonId = `export${elementId.charAt(0).toUpperCase() + elementId.slice(1)}`;
                const exportButton = document.getElementById(buttonId) || document.getElementById('exportPDF');
                const originalText = exportButton.innerHTML;
                
                this.logger.log(`üöÄ Inizio esportazione PDF per #${elementId}...`, 'info');
                
                exportButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Esportazione...';
                exportButton.disabled = true;

                const elementToCapture = document.getElementById(elementId);
                if (!elementToCapture) {
                    this.logger.log(`‚ùå Elemento #${elementId} non trovato`, 'error');
                    alert(`Errore: Impossibile trovare la sezione da esportare.`);
                    exportButton.innerHTML = originalText;
                    exportButton.disabled = false;
                    return;
                }

                html2canvas(elementToCapture, { scale: 2, useCORS: true }).then(canvas => {
                    try {
                        const imgData = canvas.toDataURL('image/png');
                        const { jsPDF } = window.jspdf;
                        
                        const pdf = new jsPDF({
                            orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                            unit: 'mm',
                            format: 'a4'
                        });

                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        const canvasAspectRatio = canvas.width / canvas.height;

                        let imgWidth = pdfWidth - 20;
                        let imgHeight = imgWidth / canvasAspectRatio;

                        if (imgHeight > pdfHeight - 20) {
                            imgHeight = pdfHeight - 20;
                            imgWidth = imgHeight * canvasAspectRatio;
                        }

                        const x = (pdfWidth - imgWidth) / 2;
                        const y = (pdfHeight - imgHeight) / 2;

                        pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
                        pdf.save(`${filename}_${new Date().toISOString().slice(0,10)}.pdf`);
                        
                        this.logger.log(`‚úÖ PDF per #${elementId} esportato`, 'success');
                    } catch (error) {
                        this.logger.log(`‚ùå Errore PDF: ${error.message}`, 'error');
                        alert('Si √® verificato un errore durante la creazione del PDF.');
                    } finally {
                        exportButton.innerHTML = originalText;
                        exportButton.disabled = false;
                    }
                });
            }

            async exportFullDashboardPDF() {
                const exportButton = document.getElementById('exportFullDashboard');
                if (!exportButton || exportButton.disabled) return;

                const originalText = exportButton.innerHTML;
                exportButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generazione Report...';
                exportButton.disabled = true;
                this.logger.log('üöÄ Inizio esportazione PDF completo v36...', 'info');

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;

                const reportLayout = [
                    { page: 1, sections: ['funnelKpiSection', 'economicKpiSection', 'advertisingKpiSection'], layout: 'center-stack' },
                    { page: 2, sections: ['funnelChartSection', 'conversionChartSection', 'efficiencySection'], layout: 'stack-scaled' },
                    { page: 3, sections: ['temporalAnalysisSection', 'temporalEconomicAnalysisSection'], layout: 'center-stack' },
                    { page: 4, sections: ['performanceChartSection', 'performanceTableSection', 'insightsPanel'], layout: 'stack' }
                ];

                try {
                    for (let i = 0; i < reportLayout.length; i++) {
                        const pageConfig = reportLayout[i];
                        if (i > 0) {
                            pdf.addPage();
                        }

                        let currentPageY = margin;
                        if (i === 0) {
                            pdf.setFontSize(18);
                            pdf.setFont('helvetica', 'bold');
                            pdf.text('Dashboard - Centro di Comando CRM', pdfWidth / 2, currentPageY, { align: 'center' });
                            pdf.setFontSize(12);
                            pdf.setFont('helvetica', 'normal');
                            pdf.text('ROI e Performance Analysis', pdfWidth / 2, currentPageY + 8, { align: 'center' });
                            currentPageY += 25;
                        }

                        const canvases = [];
                        for (const elementId of pageConfig.sections) {
                            const element = document.getElementById(elementId);
                            if (element) {
                                this.logger.log(`üì∏ Cattura sezione per pagina ${i + 1}: #${elementId}`, 'info');
                                canvases.push(await html2canvas(element, { scale: 2, useCORS: true }));
                            } else {
                                this.logger.log(`‚ö†Ô∏è Sezione #${elementId} non trovata, saltata.`, 'warning');
                            }
                        }
                        
                        let totalHeight = 0;
                        const sectionSpacing = 5; // Spazio tra le sezioni
                        
                        if (pageConfig.layout === 'center-stack') {
                            totalHeight = canvases.reduce((sum, canvas) => {
                                const imgWidth = pdfWidth - (margin * 2);
                                const imgHeight = (imgWidth / canvas.width) * canvas.height;
                                return sum + imgHeight + sectionSpacing;
                            }, 0) - sectionSpacing;
                            currentPageY = (pdfHeight - totalHeight) / 2;
                        }

                        for (const canvas of canvases) {
                            let imgWidth = pdfWidth - (margin * 2);
                            if (pageConfig.layout === 'stack-scaled') {
                                imgWidth *= 0.8; // Riduci la larghezza per i grafici
                            }
                            
                            const imgHeight = (imgWidth / canvas.width) * canvas.height;
                            const x = (pdfWidth - imgWidth) / 2;

                            if (currentPageY + imgHeight > pdfHeight - margin && canvases.indexOf(canvas) > 0) {
                                pdf.addPage();
                                currentPageY = margin;
                            }

                            const imgData = canvas.toDataURL('image/png');
                            pdf.addImage(imgData, 'PNG', x, currentPageY, imgWidth, imgHeight);
                            currentPageY += imgHeight + sectionSpacing;
                        }
                    }

                    pdf.save(`report_dashboard_completo_v36_${new Date().toISOString().slice(0,10)}.pdf`);
                    this.logger.log('‚úÖ Report PDF v36 completo esportato con successo.', 'success');

                } catch (error) {
                    this.logger.log(`‚ùå Errore durante la generazione del PDF completo: ${error.message}`, 'error');
                    console.error(error);
                    alert('Si √® verificato un errore durante la creazione del report completo.');
                } finally {
                    exportButton.innerHTML = originalText;
                    exportButton.disabled = false;
                }
            }
        }

        class Logger {
            constructor() { this.entries = []; }
            log(message, type = 'info') {
                if (!CONFIG.DEBUG_MODE) return;
                const entry = { timestamp: new Date().toLocaleTimeString(), message, type };
                this.entries.push(entry);
                if (this.entries.length > CONFIG.MAX_DEBUG_ENTRIES) this.entries.shift();
                this.render();
            }
            render() {
                const container = document.getElementById('debugContent');
                if (!container) return;
                const className = { error: 'debug-error', success: 'debug-success', warning: 'debug-warning' };
                container.innerHTML = this.entries.map(entry => `<div class="debug-section ${className[entry.type] || ''}">[${entry.timestamp}] ${entry.message}</div>`).join('');
                container.scrollTop = container.scrollHeight;
            }
        }

        class FileManager {
            constructor(app) {
                this.app = app;
                this.fileTypes = ['lead', 'campaigns', 'sales', 'weekly'];
                
                this.modes = {
                    lead: 'file',
                    campaigns: 'file',
                    sales: 'file',
                    weekly: 'file'
                };
                
                this.setupHandlers();
                this.setupModeToggles();
                this.setupURLHandlers();
                this.loadSavedUrls(); // Carica URL al boot
            }

            setupHandlers() {
                this.fileTypes.forEach(type => {
                    const dropZone = document.getElementById(`${type}DropZone`);
                    const fileInput = document.getElementById(`${type}File`);
                    
                    if (!dropZone || !fileInput) return;
                    
                    dropZone.addEventListener('click', () => fileInput.click());
                    fileInput.addEventListener('change', (e) => e.target.files[0] && this.handleFile(e.target.files[0], type));
                    
                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.classList.add('dragover');
                    });
                    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('dragover');
                        e.dataTransfer.files[0] && this.handleFile(e.dataTransfer.files[0], type);
                    });
                });
                
                this.checkProcessButton();
            }

            setupModeToggles() {
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const type = e.currentTarget.dataset.type;
                        const mode = e.currentTarget.dataset.mode;
                        this.switchMode(type, mode);
                    });
                });
            }

            setupURLHandlers() {
                document.querySelectorAll('.load-url-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const type = e.currentTarget.dataset.type;
                        this.loadFromURL(type);
                    });
                });
                
                document.querySelectorAll('.help-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        e.preventDefault();
                        const type = e.currentTarget.dataset.type;
                        const tutorial = document.querySelector(`.url-tutorial[data-type="${type}"]`);
                        if (tutorial) {
                            tutorial.classList.toggle('show');
                        }
                    });
                });

                document.querySelectorAll('.save-url-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const type = e.currentTarget.dataset.type;
                        this.toggleSaveUrl(type);
                    });
                });
            }
            
            toggleSaveUrl(type) {
                const key = `dashboard_url_${type}`;
                const urlInput = document.getElementById(`${type}URL`);
                const saveBtn = document.querySelector(`.save-url-btn[data-type="${type}"]`);
                
                if (localStorage.getItem(key) && localStorage.getItem(key) === urlInput.value.trim()) {
                    // URL √® salvato E CORRISPONDE, quindi lo rimuoviamo
                    localStorage.removeItem(key);
                    this.updateSaveButtonUI(type, false);
                    this.app.logger.log(`üóëÔ∏è URL per ${type} rimosso dalla memoria.`, 'info');
                } else {
                    // URL non √® salvato o √® diverso, quindi lo salviamo/aggiorniamo
                    const urlToSave = urlInput.value.trim();
                    if (urlToSave) {
                        localStorage.setItem(key, urlToSave);
                        this.updateSaveButtonUI(type, true);
                        this.app.logger.log(`üíæ URL per ${type} salvato in memoria.`, 'success');
                    } else {
                        localStorage.removeItem(key);
                        this.updateSaveButtonUI(type, false);
                        this.app.logger.log(`‚ö†Ô∏è Tentativo di salvare un URL vuoto per ${type}. Rimosso eventuale salvataggio precedente.`, 'warning');
                    }
                }
            }

            loadSavedUrls() {
                this.fileTypes.forEach(type => {
                    const key = `dashboard_url_${type}`;
                    const savedUrl = localStorage.getItem(key);
                    if (savedUrl) {
                        document.getElementById(`${type}URL`).value = savedUrl;
                        this.updateSaveButtonUI(type, true);
                        this.app.logger.log(`‚úÖ Trovato URL salvato per ${type}.`, 'info');
                    }
                });
            }

            updateSaveButtonUI(type, isSaved) {
                const saveBtn = document.querySelector(`.save-url-btn[data-type="${type}"]`);
                if (saveBtn) {
                    if (isSaved) {
                        saveBtn.classList.add('saved');
                        saveBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Salvato';
                        saveBtn.title = 'URL salvato in questo browser. Clicca per rimuovere.';
                    } else {
                        saveBtn.classList.remove('saved');
                        saveBtn.innerHTML = '<i class="fas fa-save mr-1"></i>Salva';
                        saveBtn.title = 'Salva questo URL nel browser per non doverlo reinserire.';
                    }
                }
            }

            switchMode(type, mode) {
                this.app.logger.log(`üîÑ Cambio modalit√† ${type}: ${this.modes[type]} ‚Üí ${mode}`, 'info');
                
                this.modes[type] = mode;
                
                const buttons = document.querySelectorAll(`.mode-btn[data-type="${type}"]`);
                buttons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });
                
                const fileModeEl = document.querySelector(`.file-mode[data-type="${type}"]`);
                const urlModeEl = document.querySelector(`.url-mode[data-type="${type}"]`);
                
                if (mode === 'file') {
                    fileModeEl?.classList.remove('hidden');
                    urlModeEl?.classList.add('hidden');
                } else {
                    fileModeEl?.classList.add('hidden');
                    urlModeEl?.classList.remove('hidden');
                }
            }

            async loadFromURL(type) {
                const urlInput = document.getElementById(`${type}URL`);
                const statusDiv = document.getElementById(`${type}UrlStatus`);
                const loadBtn = document.querySelector(`.load-url-btn[data-type="${type}"]`);
                
                const url = urlInput.value.trim();
                
                if (!url) {
                    this.showURLStatus(type, 'Inserisci un URL valido', 'error');
                    return;
                }
                
                const validation = this.validateGoogleSheetsURL(url);
                if (!validation.valid) {
                    this.showURLStatus(type, validation.error, 'error');
                    return;
                }
                
                this.app.logger.log(`üîó Caricamento ${type} da URL: ${url}`, 'info');
                
                loadBtn.disabled = true;
                this.showURLStatus(type, '‚è≥ Caricamento in corso...', 'loading');
                
                try {
                    const csvText = await this.fetchCSVFromURL(url);
                    
                    this.app.logger.log(`‚úÖ Dati scaricati da URL (${csvText.length} caratteri)`, 'success');
                    
                    Papa.parse(csvText, {
                        header: false,
                        skipEmptyLines: true,
                        complete: (results) => {
                            try {
                                if (type === 'weekly' && results.data && results.data.length > 0) {
                                    const firstRow = results.data[0];
                                    const firstCell = firstRow[0]?.toString().toLowerCase() || '';
                                    
                                    if (firstCell.includes('counta') || firstCell.includes('data richiesta')) {
                                        this.app.logger.log('‚ö†Ô∏è Weekly: Rimossa prima riga (titolo/metadati)', 'warning');
                                        results.data.shift();
                                    }
                                }
                                
                                if (!results.data || results.data.length < 2) {
                                    throw new Error('Il file deve contenere almeno header e dati');
                                }
                                
                                this.app.data.raw[type] = results.data;
                                if (type === 'lead') this.app.data.original.lead = JSON.parse(JSON.stringify(results.data));
                                else if (type === 'campaigns') this.app.data.original.campaigns = JSON.parse(JSON.stringify(results.data));
                                
                                this.showURLStatus(type, `‚úÖ ${results.data.length - 1} righe caricate con successo`, 'success');
                                this.checkProcessButton();
                                this.app.logger.log(`‚úÖ ${type} caricato da URL: ${results.data.length - 1} righe`, 'success');
                                loadBtn.disabled = false;
                                
                            } catch (error) {
                                this.showURLStatus(type, `‚ùå Errore: ${error.message}`, 'error');
                                this.app.logger.log(`‚ùå Errore parsing ${type}: ${error.message}`, 'error');
                                loadBtn.disabled = false;
                            }
                        },
                        error: (error) => {
                            this.showURLStatus(type, '‚ùå Errore nel parsing del CSV', 'error');
                            this.app.logger.log(`‚ùå Errore parsing ${type}: ${error.message}`, 'error');
                            loadBtn.disabled = false;
                        }
                    });
                    
                } catch (error) {
                    this.showURLStatus(type, `‚ùå ${error.message}`, 'error');
                    this.app.logger.log(`‚ùå Errore fetch ${type}: ${error.message}`, 'error');
                    loadBtn.disabled = false;
                }
            }

            validateGoogleSheetsURL(url) {
                if (!url.includes('docs.google.com')) {
                    return {
                        valid: false,
                        error: '‚ö†Ô∏è Solo URL di Google Sheets sono supportati (docs.google.com)'
                    };
                }
                
                const hasOutputCSV = url.includes('output=csv');
                const hasPub = url.includes('/pub?');
                
                if (!hasOutputCSV || !hasPub) {
                    return {
                        valid: false,
                        error: '‚ö†Ô∏è L\'URL deve contenere /pub? e output=csv (vedi tutorial cliccando su ?)'
                    };
                }
                
                const match = url.match(/\/d\/e\/([a-zA-Z0-9-_]+)\//);
                if (!match) {
                    return {
                        valid: false,
                        error: '‚ö†Ô∏è ID del foglio non trovato nell\'URL'
                    };
                }
                
                return {
                    valid: true,
                    sheetId: match[1]
                };
            }

            async fetchCSVFromURL(url) {
                const proxies = [
                    {
                        name: 'AllOrigins',
                        buildURL: (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
                    },
                    {
                        name: 'CodeTabs',
                        buildURL: (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
                    },
                    {
                        name: 'Direct',
                        buildURL: (url) => url
                    }
                ];
                
                let lastError = null;
                
                for (let i = 0; i < proxies.length; i++) {
                    const proxy = proxies[i];
                    try {
                        this.app.logger.log(`üîó Tentativo ${i + 1}/${proxies.length}: Proxy ${proxy.name}`, 'info');
                        
                        const proxyURL = proxy.buildURL(url);
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000);
                        
                        const response = await fetch(proxyURL, {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/csv,text/plain,*/*'
                            },
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            if (response.status === 404) {
                                throw new Error('Foglio non trovato (404). Verifica che sia pubblicato.');
                            } else if (response.status === 403) {
                                throw new Error('Accesso negato (403). Verifica le impostazioni di condivisione.');
                            } else if (response.status === 429) {
                                this.app.logger.log(`‚ö†Ô∏è Proxy ${proxy.name}: Rate limit (429), provo il prossimo...`, 'warning');
                                continue;
                            } else {
                                throw new Error(`Errore server (${response.status})`);
                            }
                        }
                        
                        const csvText = await response.text();
                        
                        if (!csvText || csvText.trim() === '') {
                            throw new Error('Il file scaricato √® vuoto');
                        }
                        
                        const lines = csvText.trim().split('\n');
                        this.app.logger.log(`‚úÖ CSV scaricato con successo tramite ${proxy.name}: ${lines.length} righe`, 'success');
                        
                        return csvText;
                        
                    } catch (error) {
                        lastError = error;
                        
                        if (error.name === 'AbortError') {
                            this.app.logger.log(`‚è±Ô∏è Proxy ${proxy.name}: Timeout dopo 15 secondi`, 'warning');
                        } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                            this.app.logger.log(`üö´ Proxy ${proxy.name}: Errore di rete`, 'warning');
                        } else {
                            this.app.logger.log(`‚ùå Proxy ${proxy.name}: ${error.message}`, 'warning');
                        }
                        
                        if (i < proxies.length - 1) {
                            this.app.logger.log(`üîÑ Provo il prossimo proxy...`, 'info');
                            continue;
                        }
                    }
                }
                
                this.app.logger.log(`‚ùå Tutti i proxy hanno fallito`, 'error');
                throw new Error(`Impossibile caricare i dati. Ultimo errore: ${lastError?.message || 'Errore sconosciuto'}. Prova a scaricare il CSV e caricarlo come file.`);
            }

            showURLStatus(type, message, status) {
                const statusDiv = document.getElementById(`${type}UrlStatus`);
                statusDiv.className = `url-status show ${status}`;
                statusDiv.textContent = message;
            }

            handleFile(file, type) {
                this.app.logger.log(`üìÅ Caricamento ${type}: ${file.name}`, 'info');
                const dropZone = document.getElementById(`${type}DropZone`);
                const status = document.getElementById(`${type}Status`);
                dropZone.classList.remove('loaded', 'error');
                status.classList.add('hidden');
                if (!file.name.toLowerCase().endsWith('.csv')) { this.showStatus(type, 'Solo file CSV supportati', 'error'); return; }
                Papa.parse(file, {
                    header: false, skipEmptyLines: true,
                    complete: (results) => {
                        try {
                            if (type === 'weekly' && results.data && results.data.length > 0) {
                                const firstRow = results.data[0];
                                const firstCell = firstRow[0]?.toString().toLowerCase() || '';
                                
                                if (firstCell.includes('counta') || firstCell.includes('data richiesta')) {
                                    this.app.logger.log('‚ö†Ô∏è Weekly: Rimossa prima riga (titolo/metadati)', 'warning');
                                    results.data.shift();
                                }
                            }
                            
                            if (!results.data || results.data.length < 2) throw new Error('File deve contenere almeno header e dati');
                            this.app.data.raw[type] = results.data;
                            if (type === 'lead') this.app.data.original.lead = JSON.parse(JSON.stringify(results.data));
                            else if (type === 'campaigns') this.app.data.original.campaigns = JSON.parse(JSON.stringify(results.data));
                            this.showStatus(type, `${file.name} - ${results.data.length - 1} righe`, 'success');
                            this.checkProcessButton();
                            this.app.logger.log(`‚úÖ ${type} caricato: ${results.data.length - 1} righe`, 'success');
                        } catch (error) {
                            this.showStatus(type, error.message, 'error');
                            this.app.logger.log(`‚ùå Errore ${type}: ${error.message}`, 'error');
                        }
                    },
                    error: (error) => this.showStatus(type, 'Errore nel parsing CSV', 'error')
                });
            }
            
            showStatus(type, message, status) {
                const dropZone = document.getElementById(`${type}DropZone`);
                const statusDiv = document.getElementById(`${type}Status`);
                dropZone.classList.remove('loaded', 'error');
                dropZone.classList.add(status);
                const icon = status === 'success' ? 'fa-check-circle text-green-600' : 'fa-exclamation-circle text-red-600';
                const color = status === 'success' ? 'text-green-600' : 'text-red-600';
                statusDiv.innerHTML = `<i class="fas ${icon} mr-1"></i><span class="${color}">${message}</span>`;
                statusDiv.classList.remove('hidden');
                if (status === 'error') { this.app.data.raw[type] = null; this.checkProcessButton(); }
            }
            
            checkProcessButton() {
                const button = document.getElementById('processButton');
                const hasRequired = this.app.data.raw.lead && this.app.data.raw.campaigns;
                if (button) { button.disabled = !hasRequired; button.classList.toggle('opacity-50', !hasRequired); button.classList.toggle('cursor-not-allowed', !hasRequired); }
            }
        }

        class FilterManager {
            constructor(app) { this.app = app; this.setupEventListeners(); }
            setupEventListeners() {
                document.getElementById('filterPeriodo')?.addEventListener('change', (e) => this.handlePeriodChange(e.target.value));
                const filterIds = ['filterFonte', 'filterMezzo', 'filterPuntoVendita', 'filterRiattivazione', 'filterPersonType', 'dateStart', 'dateEnd'];
                filterIds.forEach(id => { document.getElementById(id)?.addEventListener('change', () => this.updateCounter()); });
            }
            handlePeriodChange(value) {
                const customInputs = document.getElementById('customDateInputs');
                customInputs.classList.toggle('show', value === 'custom');
                if (value !== 'tutto' && value !== 'custom') {
                    const today = new Date();
                    const startDate = new Date(today);
                    startDate.setDate(today.getDate() - parseInt(value));
                    document.getElementById('dateStart').value = startDate.toISOString().split('T')[0];
                    document.getElementById('dateEnd').value = today.toISOString().split('T')[0];
                }
                this.updateCounter();
            }
            updateCounter() {
                let total = 0;
                if (document.getElementById('filterPeriodo').value !== 'tutto') total++;
                ['filterFonte', 'filterMezzo', 'filterPuntoVendita', 'filterRiattivazione', 'filterPersonType'].forEach(id => {
                    const select = document.getElementById(id);
                    if (select?.value !== '') total++;
                });
                const indicator = document.getElementById('filtersActiveIndicator');
                const count = document.getElementById('filtersActiveCount');
                if (total > 0) { indicator.classList.remove('hidden'); count.textContent = total; } 
                else { indicator.classList.add('hidden'); }
            }
            populate() {
                if (!this.app.data.original.lead) return;
                this.app.logger.log('üéõÔ∏è Popolamento filtri...', 'info');
                const headers = this.app.data.original.lead[0];
                const rows = this.app.data.original.lead.slice(1);
                const indices = {
                    fonte: headers.findIndex(h => h.toLowerCase().includes('fonte')),
                    mezzo: headers.findIndex(h => h.toLowerCase().includes('mezzo')),
                    personType: headers.findIndex(h => h.toLowerCase().includes('person') && h.toLowerCase().includes('type'))
                };
                this.app.filters.options.fonti.clear();
                this.app.filters.options.mezzi.clear();
                this.app.filters.options.personTypes.clear();
                rows.forEach(row => {
                    if (indices.fonte >= 0 && row[indices.fonte]) this.app.filters.options.fonti.add(row[indices.fonte].trim());
                    if (indices.mezzo >= 0 && row[indices.mezzo]) this.app.filters.options.mezzi.add(row[indices.mezzo].trim());
                    if (indices.personType >= 0 && row[indices.personType]) this.app.filters.options.personTypes.add(row[indices.personType].trim());
                });
                this.populateDropdown('filterFonte', Array.from(this.app.filters.options.fonti).sort());
                this.populateDropdown('filterMezzo', Array.from(this.app.filters.options.mezzi).sort());
                this.populateDropdown('filterPersonType', Array.from(this.app.filters.options.personTypes).sort());
                this.app.logger.log(`‚úÖ Filtri popolati: ${this.app.filters.options.fonti.size} fonti`, 'success');
            }
            populateDropdown(selectId, options) {
                const select = document.getElementById(selectId);
                if (!select) return;
                const firstOption = select.children[0];
                select.innerHTML = '';
                select.appendChild(firstOption);
                options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    select.appendChild(opt);
                });
            }
            apply() {
                this.app.logger.log('‚úÖ Applicazione filtri...', 'info');
                const state = this.app.filters.state;
                state.periodo = document.getElementById('filterPeriodo').value;
                state.dateStart = document.getElementById('dateStart').value;
                state.dateEnd = document.getElementById('dateEnd').value;
                state.fonte = document.getElementById('filterFonte').value;
                state.mezzo = document.getElementById('filterMezzo').value;
                state.puntoVendita = document.getElementById('filterPuntoVendita').value;
                state.riattivazione = document.getElementById('filterRiattivazione').value;
                state.personType = document.getElementById('filterPersonType').value;
                state.active = true;
                this.app.data.filtered.leadByPeriod = this.filterLeadByPeriod(this.app.data.original.lead);
                this.app.data.filtered.campaigns = this.filterCampaignsByPeriod(this.app.data.original.campaigns);
                this.app.data.filtered.leadFullyFiltered = this.filterByAllCriteria(this.app.data.original.lead);
                const leadDataForFunnel = this.app.dataProcessor.processLead(this.app.data.filtered.leadFullyFiltered);
                const leadDataForPerformance = this.app.dataProcessor.processLead(this.app.data.filtered.leadByPeriod);
                const campaignData = this.app.dataProcessor.processCampaigns(this.app.data.filtered.campaigns);
                this.app.dataProcessor.calculateFunnel(leadDataForFunnel);
                this.app.dataProcessor.calculateEconomic(leadDataForFunnel);
                this.app.dataProcessor.calculateAdvertising(leadDataForPerformance, campaignData);
                this.app.dataProcessor.calculateSourcePerformance(leadDataForPerformance, campaignData);
                this.app.dataProcessor.calculateConversionRates();
                this.app.dataProcessor.calculatePerformanceBubbles();
                this.app.dataProcessor.calculateEfficiencyIndices();
                this.app.dataProcessor.calculateTemporalData(leadDataForFunnel, campaignData);
                this.app.render();
                this.app.logger.log('‚úÖ Filtri applicati correttamente', 'success');
            }
            filterLeadByPeriod(data) {
                if (!data || this.app.filters.state.periodo === 'tutto') return data;
                const headers = data[0];
                const rows = data.slice(1);
                const dateIndex = headers.findIndex(h => h.toLowerCase().includes('data richiesta') || h.toLowerCase().includes('data contatto'));
                if (dateIndex === -1) { this.app.logger.log('‚ö†Ô∏è Colonna "Data Richiesta" non trovata in Lead, skip filtro periodo', 'warning'); return data; }
                const { dateStart, dateEnd } = this.app.filters.state;
                if (!dateStart || !dateEnd) return data;
                const startDate = new Date(dateStart); startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(dateEnd); endDate.setHours(23, 59, 59, 999);
                const filteredRows = rows.filter(row => {
                    const cellValue = (row[dateIndex] || '').trim();
                    if (!cellValue) return false;
                    const rowDate = Utils.parseItalianDate(cellValue);
                    if (!rowDate) { this.app.logger.log(`‚ö†Ô∏è Data invalida ignorata: "${cellValue}"`, 'warning'); return false; }
                    return rowDate >= startDate && rowDate <= endDate;
                });
                return [headers, ...filteredRows];
            }
            filterCampaignsByPeriod(data) {
                if (!data || this.app.filters.state.periodo === 'tutto') return data;
                const headers = data[0];
                const rows = data.slice(1);
                const yearMonthIndex = headers.findIndex(h => h.toLowerCase().includes('anno') && h.toLowerCase().includes('mese'));
                if (yearMonthIndex === -1) { this.app.logger.log('‚ö†Ô∏è Colonna "Anno/Mese" non trovata in Campaigns, skip filtro periodo', 'warning'); return data; }
                const { dateStart, dateEnd } = this.app.filters.state;
                if (!dateStart || !dateEnd) return data;
                const startDate = new Date(dateStart); const endDate = new Date(dateEnd);
                const startYearMonth = { year: startDate.getFullYear(), month: startDate.getMonth() + 1 };
                const endYearMonth = { year: endDate.getFullYear(), month: endDate.getMonth() + 1 };
                const filteredRows = rows.filter(row => {
                    const cellValue = (row[yearMonthIndex] || '').trim();
                    if (cellValue.toLowerCase().includes('totale') || cellValue.toLowerCase().includes('ultimi') || cellValue.toLowerCase().includes('progressiv')) return false;
                    if (!cellValue) return false;
                    const parsed = Utils.parseYearMonth(cellValue);
                    if (!parsed) { this.app.logger.log(`‚ö†Ô∏è Anno/Mese invalido ignorato: "${cellValue}"`, 'warning'); return false; }
                    const rowYearMonth = parsed.year * 12 + parsed.month;
                    const startYM = startYearMonth.year * 12 + startYearMonth.month;
                    const endYM = endYearMonth.year * 12 + endYearMonth.month;
                    return rowYearMonth >= startYM && rowYearMonth <= endYM;
                });
                return [headers, ...filteredRows];
            }
            filterByAllCriteria(data) {
                if (!data) return data;
                const headers = data[0];
                const rows = data.slice(1);
                let filteredRows = rows;
                const dateIndex = headers.findIndex(h => h.toLowerCase().includes('data richiesta') || h.toLowerCase().includes('data contatto'));
                if (this.app.filters.state.periodo !== 'tutto' && dateIndex >= 0) {
                    const { dateStart, dateEnd } = this.app.filters.state;
                    if (dateStart && dateEnd) {
                        const startDate = new Date(dateStart); startDate.setHours(0, 0, 0, 0);
                        const endDate = new Date(dateEnd); endDate.setHours(23, 59, 59, 999);
                        filteredRows = filteredRows.filter(row => {
                            const cellValue = (row[dateIndex] || '').trim();
                            if (!cellValue) return false;
                            const rowDate = Utils.parseItalianDate(cellValue);
                            if (!rowDate) return false;
                            return rowDate >= startDate && rowDate <= endDate;
                        });
                    }
                }
                const indices = {
                    fonte: headers.findIndex(h => h.toLowerCase().includes('fonte')),
                    mezzo: headers.findIndex(h => h.toLowerCase().includes('mezzo')),
                    personType: headers.findIndex(h => h.toLowerCase().includes('person') && h.toLowerCase().includes('type')),
                    riattivazione: headers.findIndex(h => h.toLowerCase().includes('riattivazione') || h.toLowerCase().includes('riattivabile')),
                    puntoVendita: headers.findIndex(h => h.toLowerCase().includes('punto') && h.toLowerCase().includes('vendita'))
                };
                const state = this.app.filters.state;
                filteredRows = filteredRows.filter(row => {
                    if (state.fonte && indices.fonte >= 0 && (row[indices.fonte] || '').trim().toLowerCase() !== state.fonte.toLowerCase()) return false;
                    if (state.mezzo && indices.mezzo >= 0 && (row[indices.mezzo] || '').trim().toLowerCase() !== state.mezzo.toLowerCase()) return false;
                    if (state.personType && indices.personType >= 0 && (row[indices.personType] || '').trim().toLowerCase() !== state.personType.toLowerCase()) return false;
                    if (state.puntoVendita && indices.puntoVendita >= 0 && (row[indices.puntoVendita] || '').trim().toLowerCase() !== state.puntoVendita.toLowerCase()) return false;
                    if (state.riattivazione && indices.riattivazione >= 0) {
                        const cellValue = (row[indices.riattivazione] || '').trim().toLowerCase();
                        const isTrue = ['true', 'vero', '1', 's√¨', 'si'].includes(cellValue);
                        const isFalse = ['false', 'falso', '0', 'no'].includes(cellValue);
                        if (state.riattivazione === 'VERO' && !isTrue) return false;
                        if (state.riattivazione === 'FALSO' && !isFalse) return false;
                    }
                    return true;
                });
                return [headers, ...filteredRows];
            }
            reset() {
                this.app.logger.log('üîÑ Reset filtri...', 'info');
                document.getElementById('filterPeriodo').value = 'tutto';
                document.getElementById('customDateInputs').classList.remove('show');
                document.getElementById('dateStart').value = '';
                document.getElementById('dateEnd').value = '';
                ['filterFonte', 'filterMezzo', 'filterPuntoVendita', 'filterRiattivazione', 'filterPersonType'].forEach(id => {
                    const select = document.getElementById(id);
                    if (select) select.value = '';
                });
                Object.keys(this.app.filters.state).forEach(key => { this.app.filters.state[key] = key === 'periodo' ? 'tutto' : (key === 'active' ? false : ''); });
                this.app.data.filtered.leadByPeriod = this.app.data.original.lead;
                this.app.data.filtered.leadFullyFiltered = this.app.data.original.lead;
                this.app.data.filtered.campaigns = this.app.data.original.campaigns;
                this.updateCounter();
                const leadData = this.app.dataProcessor.processLead(this.app.data.original.lead);
                const campaignData = this.app.dataProcessor.processCampaigns(this.app.data.original.campaigns);
                this.app.dataProcessor.calculateMetrics(leadData, campaignData);
                this.app.render();
                this.app.logger.log('‚úÖ Filtri resettati', 'success');
            }
        }

        class DataProcessor {
            constructor(app) { this.app = app; }
            processLead(leadDataRaw) {
                if (!leadDataRaw || leadDataRaw.length < 2) return [];
                const [headers, ...rows] = leadDataRaw;
                const getIndex = (terms) => headers.findIndex(h => terms.some(term => h.toLowerCase().includes(term.toLowerCase())));
                const valoreVendutoIndex = headers.findIndex(h => h === 'Valore del Venduto');
                const indices = {
                    contattato: getIndex(['contattato']), offerta: getIndex(['offerta']), venduto: getIndex(['venduto']),
                    valore: valoreVendutoIndex >= 0 ? valoreVendutoIndex : getIndex(['valore']),
                    fonte: getIndex(['fonte']), data: getIndex(['data richiesta', 'data contatto'])
                };
                return rows.map(row => {
                    const contattato = (row[indices.contattato] || '').toString().trim().toLowerCase();
                    const offerta = (row[indices.offerta] || '').toString().trim().toLowerCase();
                    const vendutoRaw = (row[indices.venduto] || '').toString().trim();
                    const valoreRaw = (row[indices.valore] || '').toString().trim();
                    const vendutoLower = vendutoRaw.toLowerCase().replace(/\s/g, '');
                    const isVenduto = ['si', 's√¨', 'yes'].includes(vendutoLower);
                    const valore = isVenduto ? Utils.parseItalianCurrency(valoreRaw) : 0;
                    return {
                        contattato, offerta, venduto: vendutoRaw, valore,
                        fonte: row[indices.fonte] || 'Sconosciuta',
                        data: Utils.parseItalianDate(row[indices.data]),
                        isLead: ['si', 's√¨', 'yes'].includes(contattato.replace(/\s/g, '')),
                        isProspect: ['si', 's√¨', 'yes'].includes(offerta.replace(/\s/g, '')),
                        isCliente: isVenduto,
                        isGhost: ['no', 'n'].includes(contattato),
                        isNonLavorato: contattato === '' || contattato === 'pending'
                    };
                });
            }
            processCampaigns(campaignsDataRaw) {
                if (!campaignsDataRaw || campaignsDataRaw.length < 2) return [];
                const [headers, ...rows] = campaignsDataRaw;
                const getIndex = (terms) => headers.findIndex(h => terms.some(term => h.toLowerCase().includes(term.toLowerCase())));
                const indices = {
                    annoMese: 0, costo: getIndex(['costo piattaforme']), cpc: getIndex(['cpc']),
                    contatti: getIndex(['n¬∫ contatti']), roi: getIndex(['roi']), fatturato: getIndex(['fatturato'])
                };
                return rows
                    .filter(row => {
                        const annoMese = (row[indices.annoMese] || '').trim();
                        return annoMese && !annoMese.toLowerCase().includes('totale') && !annoMese.toLowerCase().includes('ultimi') && !annoMese.toLowerCase().includes('progressiv');
                    })
                    .map(row => ({
                        annoMese: Utils.parseYearMonth(row[indices.annoMese]),
                        spesa: Utils.parseItalianCurrency(row[indices.costo]),
                        cpc: Utils.parseItalianCurrency(row[indices.cpc]),
                        contatti: parseFloat(row[indices.contatti]) || 0,
                        roi: parseFloat(row[indices.roi]) || 0,
                        fatturato: Utils.parseItalianCurrency(row[indices.fatturato])
                    }));
            }
            calculateMetrics(leadData, campaignData) {
                this.calculateFunnel(leadData);
                this.calculateEconomic(leadData);
                this.calculateAdvertising(leadData, campaignData);
                this.calculateSourcePerformance(leadData, campaignData);
                this.calculateConversionRates();
                this.calculatePerformanceBubbles();
                this.calculateEfficiencyIndices();
                this.calculateTemporalData(leadData, campaignData);
            }
            calculateFunnel(leadData) {
                this.app.data.processed.funnel = {
                    contatti: leadData.length,
                    lead: leadData.filter(r => r.isLead).length,
                    prospect: leadData.filter(r => r.isProspect).length,
                    clienti: leadData.filter(r => r.isCliente).length,
                    ghost: leadData.filter(r => r.isGhost).length,
                    nonLavorati: leadData.filter(r => r.isNonLavorato).length
                };
            }
            calculateEconomic(leadData) {
                const valoreVenduto = leadData.reduce((sum, r) => sum + r.valore, 0);
                const clienti = this.app.data.processed.funnel.clienti;
                this.app.data.processed.economic = { valoreVenduto, aov: clienti > 0 ? valoreVenduto / clienti : 0 };
            }
            calculateAdvertising(leadData, campaignData) {
                const validCampaigns = campaignData.filter(c => c.annoMese);
                const spesaTotale = validCampaigns.reduce((sum, r) => sum + r.spesa, 0);
                const leadCountForCPL = leadData.filter(r => r.isLead).length;
                const prospectCountForCPO = leadData.filter(r => r.isProspect).length;
                const clientiCountForCPV = leadData.filter(r => r.isCliente).length;
                const contattiCountForCPC = leadData.length;
                const fatturatoCalcolato = leadData.reduce((sum, r) => sum + r.valore, 0);
                const roiCalcolato = spesaTotale > 0 ? (fatturatoCalcolato - spesaTotale) / spesaTotale : 0;
                this.app.data.processed.advertising = {
                    spesaTotale, roi: roiCalcolato,
                    valoreContatto: contattiCountForCPC > 0 ? fatturatoCalcolato / contattiCountForCPC : 0,
                    cpcMedio: contattiCountForCPC > 0 ? spesaTotale / contattiCountForCPC : 0,
                    cpl: leadCountForCPL > 0 ? spesaTotale / leadCountForCPL : 0,
                    cpo: prospectCountForCPO > 0 ? spesaTotale / prospectCountForCPO : 0,
                    cpvMedio: clientiCountForCPV > 0 ? spesaTotale / clientiCountForCPV : 0
                };
            }
            calculateEfficiencyIndices() {
                const { contatti, lead, prospect, clienti } = this.app.data.processed.funnel;
                this.app.data.processed.efficiency = {
                    contattiPerOfferta: prospect > 0 ? Math.round(contatti / prospect) : 0,
                    contattiPerVendita: clienti > 0 ? Math.round(contatti / clienti) : 0,
                    leadPerOfferta: prospect > 0 ? Math.round(lead / prospect) : 0,
                    leadPerVendita: clienti > 0 ? Math.round(lead / clienti) : 0,
                    offertePerVendita: clienti > 0 ? Math.round(prospect / clienti) : 0,
                    rateOC: contatti > 0 ? (prospect / contatti) * 100 : 0,
                    rateVC: contatti > 0 ? (clienti / contatti) * 100 : 0,
                    rateOL: lead > 0 ? (prospect / lead) * 100 : 0,
                    rateVL: lead > 0 ? (clienti / lead) * 100 : 0,
                    rateVO: prospect > 0 ? (clienti / prospect) * 100 : 0,
                };
            }
            calculateTemporalData(leadData, campaignData) {
                const weekly = {}, monthly = {}, annual = {};
                leadData.forEach(row => {
                    if (!row.data) return;
                    const date = row.data;
                    const weekKey = Utils.getWeekKey(date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const yearKey = date.getFullYear().toString();
                    [weekly, monthly, annual].forEach(agg => {
                        const key = agg === weekly ? weekKey : (agg === monthly ? monthKey : yearKey);
                        if (!agg[key]) agg[key] = { contatti: 0, lead: 0, prospect: 0, clienti: 0, fatturato: 0 };
                        agg[key].contatti++;
                        if (row.isLead) agg[key].lead++;
                        if (row.isProspect) agg[key].prospect++;
                        if (row.isCliente) { agg[key].clienti++; agg[key].fatturato += row.valore; }
                    });
                });
                campaignData.forEach(row => {
                    if (!row.annoMese) return;
                    const monthKey = `${row.annoMese.year}-${String(row.annoMese.month).padStart(2, '0')}`;
                    const yearKey = row.annoMese.year.toString();
                    if (monthly[monthKey]) monthly[monthKey].spesa = (monthly[monthKey].spesa || 0) + row.spesa;
                    else monthly[monthKey] = { contatti: 0, lead: 0, prospect: 0, clienti: 0, fatturato: 0, spesa: row.spesa };
                    if (annual[yearKey]) annual[yearKey].spesa = (annual[yearKey].spesa || 0) + row.spesa;
                    else annual[yearKey] = { contatti: 0, lead: 0, prospect: 0, clienti: 0, fatturato: 0, spesa: row.spesa };
                });
                [monthly, annual].forEach(agg => {
                    Object.values(agg).forEach(period => {
                        period.roi = period.spesa > 0 ? (period.fatturato - period.spesa) / period.spesa : 0;
                    });
                });
                this.app.data.processed.temporal = { weekly, monthly, annual };
            }
            calculateSourcePerformance(leadData, campaignData) {
                const sourceStats = {};
                leadData.forEach(row => {
                    const fonte = row.fonte.toLowerCase();
                    if (!sourceStats[fonte]) sourceStats[fonte] = { contatti: 0, lead: 0, prospect: 0, clienti: 0, valore: 0, spesa: 0, roi: 0, ghost: 0, nomeOriginale: row.fonte };
                    sourceStats[fonte].contatti++;
                    if (row.isLead) sourceStats[fonte].lead++;
                    if (row.isProspect) sourceStats[fonte].prospect++;
                    if (row.isCliente) { sourceStats[fonte].clienti++; sourceStats[fonte].valore += row.valore; }
                    if (row.isGhost) sourceStats[fonte].ghost++;
                });
                campaignData.forEach(campaign => {
                    if (!campaign.annoMese) return;
                    const fonte = `${campaign.annoMese.year}/${campaign.annoMese.month}`;
                    if (fonte.includes('totale') || fonte === '' || campaign.spesa === 0) return;
                    if (!sourceStats[fonte]) sourceStats[fonte] = { contatti: 0, lead: 0, prospect: 0, clienti: 0, valore: 0, spesa: 0, roi: 0, ghost: 0, nomeOriginale: fonte };
                    sourceStats[fonte].spesa += campaign.spesa;
                });
                Object.values(sourceStats).forEach(stats => { if (stats.spesa > 0) stats.roi = (stats.valore - stats.spesa) / stats.spesa; });
                this.app.data.processed.performance = sourceStats;
            }
            calculateConversionRates() {
                const f = this.app.data.processed.funnel;
                this.app.data.processed.conversionRates = {
                    ghostPercentage: f.contatti > 0 ? (f.ghost / f.contatti) * 100 : 0,
                    contattiToLead: f.contatti > 0 ? (f.lead / f.contatti) * 100 : 0,
                    contattiToProspect: f.contatti > 0 ? (f.prospect / f.contatti) * 100 : 0,
                    leadToProspect: f.lead > 0 ? (f.prospect / f.lead) * 100 : 0,
                    prospectToClienti: f.prospect > 0 ? (f.clienti / f.prospect) * 100 : 0,
                    conversioneTotale: f.contatti > 0 ? (f.clienti / f.contatti) * 100 : 0
                };
            }
            calculatePerformanceBubbles() {
                const performance = this.app.data.processed.performance;
                const bubbleData = [];
                Object.entries(performance)
                    .filter(([fonte, stats]) => !fonte.includes('totale') && stats.contatti > 0)
                    .forEach(([fonte, stats], index) => {
                        const conversione = stats.contatti > 0 ? ((stats.clienti / stats.contatti) * 100) : 0;
                        const aov = stats.clienti > 0 ? stats.valore / stats.clienti : 0;
                        bubbleData.push({
                            x: stats.contatti, y: conversione, r: Math.sqrt(stats.valore / 1000),
                            fonte: stats.nomeOriginale || fonte, fatturato: stats.valore, aov: aov,
                            backgroundColor: CONFIG.GENERIC_CHART_COLORS[index % CONFIG.GENERIC_CHART_COLORS.length],
                            borderColor: CONFIG.GENERIC_CHART_COLORS[index % CONFIG.GENERIC_CHART_COLORS.length]
                        });
                    });
                this.app.data.processed.performanceBubbles = bubbleData;
            }
        }

        class Utils {
            static parseItalianCurrency(value) {
                if (!value || value === '' || value === '-') return 0;
                const cleaned = String(value).trim().replace(/‚Ç¨/g, '').replace(/\s/g, '').replace(/\./g, '').replace(/,/g, '.');
                const num = parseFloat(cleaned);
                return isNaN(num) ? 0 : num;
            }
            static parseItalianDate(dateStr) {
                if (!dateStr || dateStr.trim() === '') return null;
                const cleaned = dateStr.trim();
                const parts = cleaned.split(/[\/\-]/);
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                        const date = new Date(year, month, day);
                        if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) return date;
                    }
                }
                const isoDate = new Date(cleaned);
                if (!isNaN(isoDate.getTime())) return isoDate;
                return null;
            }
            static parseYearMonth(yearMonthStr) {
                if (!yearMonthStr || yearMonthStr.trim() === '') return null;
                const cleaned = yearMonthStr.trim();
                const parts = cleaned.split('/');
                if (parts.length === 2) {
                    const year = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10);
                    if (!isNaN(year) && !isNaN(month) && month >= 1 && month <= 12) return { year, month };
                }
                return null;
            }
            static getWeekKey(date) {
                const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                const dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
            }
            static formatCurrency(value) { return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(value); }
            static getConversionColor(percentage, isGhost = false) {
                if (isGhost) {
                    if (percentage > CONFIG.GHOST_THRESHOLDS.WARNING) return '#dc2626';
                    if (percentage >= CONFIG.GHOST_THRESHOLDS.EXCELLENT) return '#f59e0b';
                    return '#10b981';
                }
                if (percentage < 20) return '#ef4444';
                if (percentage <= 40) return '#f59e0b';
                return '#10b981';
            }
            static getPerformanceBadgeClass(percentage) {
                const value = parseFloat(percentage);
                const t = CONFIG.PERFORMANCE_THRESHOLDS;
                if (value >= t.GOOD) return 'badge-excellent';
                if (value >= t.MEDIUM) return 'badge-good';
                if (value >= t.LOW) return 'badge-medium';
                if (value >= t.CRITICAL) return 'badge-low';
                return 'badge-critical';
            }
            static getDataColorClass(columnType) {
                const classes = { contatti: 'data-contatti', lead: 'data-lead', prospect: 'data-prospect', clienti: 'data-clienti', fatturato: 'data-fatturato' };
                return classes[columnType] || '';
            }
            static calculateTotals(performance) {
                const totali = { contatti: 0, lead: 0, prospect: 0, clienti: 0, valore: 0, ghost: 0 };
                Object.entries(performance).forEach(([fonte, stats]) => {
                    if (!fonte.includes('totale') && stats.contatti > 0) Object.keys(totali).forEach(key => totali[key] += stats[key] || 0);
                });
                return totali;
            }
        }

        class ChartRenderer {
            constructor(app) { this.app = app; }
            renderAll() { this.renderFunnel(); this.renderConversion(); this.renderPerformance(); this.renderTemporalFunnelChart(); this.renderTemporalEconomicChart(); }
            renderTemporalFunnelChart() {
                const agg = this.app.currentFunnelAggregation;
                const canvas = document.getElementById('temporalFunnelChart');
                if (!canvas) return;
                const temporalData = this.app.data.processed.temporal[agg];
                if (!temporalData) return;
                const sortedKeys = Object.keys(temporalData).sort();
                const datasets = [
                    { label: 'Contatti', data: sortedKeys.map(k => temporalData[k].contatti), borderColor: CONFIG.CHART_COLORS.contatti, tension: 0.1, yAxisID: 'y' },
                    { label: 'Lead', data: sortedKeys.map(k => temporalData[k].lead), borderColor: CONFIG.CHART_COLORS.lead, tension: 0.1, yAxisID: 'y' },
                    { label: 'Prospect', data: sortedKeys.map(k => temporalData[k].prospect), borderColor: CONFIG.CHART_COLORS.prospect, tension: 0.1, yAxisID: 'y' },
                    { label: 'Clienti', data: sortedKeys.map(k => temporalData[k].clienti), borderColor: CONFIG.CHART_COLORS.clienti, tension: 0.1, yAxisID: 'y' }
                ];
                if (this.app.charts.temporalFunnel) this.app.charts.temporalFunnel.destroy();
                this.app.charts.temporalFunnel = new Chart(canvas.getContext('2d'), {
                    type: 'line', data: { labels: sortedKeys, datasets },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Conteggio' } } } }
                });
            }
            renderTemporalEconomicChart() {
                const agg = this.app.currentEconomicAggregation;
                const canvas = document.getElementById('temporalEconomicChart');
                if (!canvas) return;
                const temporalData = this.app.data.processed.temporal[agg];
                if (!temporalData) { if (this.app.charts.temporalEconomic) this.app.charts.temporalEconomic.destroy(); return; }
                const sortedKeys = Object.keys(temporalData).sort();
                const datasets = [
                    { type: 'bar', label: 'Spesa', data: sortedKeys.map(k => temporalData[k].spesa || 0), backgroundColor: CONFIG.CHART_COLORS.spesa, yAxisID: 'y' },
                    { type: 'bar', label: 'Fatturato', data: sortedKeys.map(k => temporalData[k].fatturato || 0), backgroundColor: CONFIG.CHART_COLORS.fatturato, yAxisID: 'y' },
                    { type: 'line', label: 'N¬∞ Vendite', data: sortedKeys.map(k => temporalData[k].clienti || 0), borderColor: CONFIG.CHART_COLORS.vendite, tension: 0.1, yAxisID: 'y1' },
                    { type: 'line', label: 'ROI', data: sortedKeys.map(k => temporalData[k].roi || 0), borderColor: CONFIG.CHART_COLORS.roi, tension: 0.1, yAxisID: 'y1' }
                ];
                if (this.app.charts.temporalEconomic) this.app.charts.temporalEconomic.destroy();
                this.app.charts.temporalEconomic = new Chart(canvas.getContext('2d'), {
                    data: { labels: sortedKeys, datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { tooltip: { callbacks: { label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null) {
                                if (label.includes('Spesa') || label.includes('Fatturato')) label += Utils.formatCurrency(context.parsed.y);
                                else if (label.includes('ROI')) label += `${context.parsed.y.toFixed(1)}X`;
                                else label += context.parsed.y;
                            }
                            return label;
                        }}}},
                        scales: {
                            y: { type: 'linear', position: 'left', beginAtZero: true, title: { display: true, text: 'Valore (‚Ç¨)' }, ticks: { callback: function(value) { return '‚Ç¨ ' + value.toLocaleString('it-IT'); }}},
                            y1: { type: 'linear', position: 'right', beginAtZero: true, title: { display: true, text: 'Conteggio / ROI (X)' }, grid: { drawOnChartArea: false }, ticks: { callback: function(value) { return Number.isInteger(value) ? value : value.toFixed(1); }}}
                        }
                    }
                });
            }
            renderFunnel() {
                const canvas = document.getElementById('funnelChart');
                if (!canvas) return;
                const { funnel } = this.app.data.processed;
                if (this.app.charts.funnel) this.app.charts.funnel.destroy();
                this.app.charts.funnel = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Contatti', 'Lead', 'Prospect', 'Clienti'],
                        datasets: [{ label: 'Funnel', data: [funnel.contatti, funnel.lead, funnel.prospect, funnel.clienti], backgroundColor: [CONFIG.CHART_COLORS.contatti, CONFIG.CHART_COLORS.lead, CONFIG.CHART_COLORS.prospect, CONFIG.CHART_COLORS.clienti], borderRadius: 8 }]
                    },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true }, y: { grid: { display: false } } } }
                });
            }
            renderConversion() {
                const canvas = document.getElementById('conversionChart');
                if (!canvas) return;
                const { conversionRates } = this.app.data.processed;
                if (this.app.charts.conversion) this.app.charts.conversion.destroy();
                const data = [conversionRates.ghostPercentage, conversionRates.contattiToLead, conversionRates.contattiToProspect, conversionRates.leadToProspect, conversionRates.prospectToClienti, conversionRates.conversioneTotale];
                const colors = [
                    Utils.getConversionColor(conversionRates.ghostPercentage, true), Utils.getConversionColor(conversionRates.contattiToLead),
                    Utils.getConversionColor(conversionRates.contattiToProspect), Utils.getConversionColor(conversionRates.leadToProspect),
                    Utils.getConversionColor(conversionRates.prospectToClienti), Utils.getConversionColor(conversionRates.conversioneTotale)
                ];
                this.app.charts.conversion = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['üö® Ghost %', 'Contatti ‚Üí Lead', 'Contatti ‚Üí Prospect', 'Lead ‚Üí Prospect', 'Prospect ‚Üí Clienti', 'Conversione Totale'],
                        datasets: [{ label: 'Tasso %', data: data, backgroundColor: colors.map(color => color + '80'), borderColor: colors, borderWidth: 2, borderRadius: 8 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `${ctx.parsed.y.toFixed(1)}%` } } },
                        scales: { y: { beginAtZero: true, max: 100, ticks: { callback: (value) => value + '%' } }, x: { grid: { display: false }, ticks: { maxRotation: 45 } } },
                        onClick: () => this.app.openDrillDownModal()
                    }
                });
            }
            renderPerformance() {
                const canvas = document.getElementById('performanceChart');
                if (!canvas) return;
                const { performanceBubbles } = this.app.data.processed;
                if (this.app.charts.performance) this.app.charts.performance.destroy();
                this.app.charts.performance = new Chart(canvas.getContext('2d'), {
                    type: 'bubble',
                    data: { datasets: [{ label: 'Performance per Fonte', data: performanceBubbles, backgroundColor: performanceBubbles.map(d => d.backgroundColor + '60'), borderColor: performanceBubbles.map(d => d.borderColor), borderWidth: 2 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: {
                            title: (ctx) => ctx[0].raw.fonte,
                            label: (ctx) => {
                                const d = ctx.raw;
                                return [`Volume Contatti: ${d.x.toLocaleString()}`, `Tasso Conversione: ${d.y.toFixed(1)}%`, `Fatturato: ${Utils.formatCurrency(d.fatturato)}`, `AOV: ${Utils.formatCurrency(d.aov)}`];
                            }
                        }}},
                        scales: {
                            x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Volume Contatti' }, beginAtZero: true },
                            y: { title: { display: true, text: 'Tasso Conversione (%)' }, beginAtZero: true, max: Math.max(...performanceBubbles.map(d => d.y)) * 1.2 }
                        },
                        onClick: () => this.app.openPerformanceModal()
                    }
                });
            }
        }

        class TableRenderer {
            constructor(app) { this.app = app; }
            render() {
                const container = document.getElementById('performanceTableContainer');
                if (!container) return;
                const { performance } = this.app.data.processed;
                const realSources = Object.entries(performance).filter(([fonte, stats]) => !fonte.includes('totale') && stats.contatti > 0).sort((a, b) => b[1].valore - a[1].valore);
                let html = `<div class="performance-table header"><div class="fonte-col">FONTE</div><div class="numeric-col">CONTATTI</div><div class="numeric-col">LEAD</div><div class="numeric-col">PROSPECT</div><div class="numeric-col">CLIENTI</div><div class="fatturato-col">FATTURATO</div><div class="percentage-col">TASSO CONVERSIONE %</div></div>`;
                realSources.forEach(([fonte, stats]) => {
                    const conversionRate = stats.contatti > 0 ? ((stats.clienti / stats.contatti) * 100) : 0;
                    const nomeDisplay = stats.nomeOriginale || fonte;
                    html += `<div class="performance-table"><div class="fonte-col">${nomeDisplay}</div><div class="numeric-col ${Utils.getDataColorClass('contatti')}">${stats.contatti.toLocaleString()}</div><div class="numeric-col ${Utils.getDataColorClass('lead')}">${stats.lead.toLocaleString()}</div><div class="numeric-col ${Utils.getDataColorClass('prospect')}">${stats.prospect.toLocaleString()}</div><div class="numeric-col ${Utils.getDataColorClass('clienti')}">${stats.clienti.toLocaleString()}</div><div class="fatturato-col ${Utils.getDataColorClass('fatturato')}">${stats.valore.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‚Ç¨</div><div class="percentage-col"><span class="badge ${Utils.getPerformanceBadgeClass(conversionRate)}">${conversionRate.toFixed(1)}%</span></div></div>`;
                });
                const totali = Utils.calculateTotals(performance);
                const tassoTotale = totali.contatti > 0 ? ((totali.clienti / totali.contatti) * 100) : 0;
                html += `<div class="performance-table totali-row"><div class="fonte-col">TOTALE</div><div class="numeric-col ${Utils.getDataColorClass('contatti')}">${totali.contatti.toLocaleString()}</div><div class="numeric-col ${Utils.getDataColorClass('lead')}">${totali.lead.toLocaleString()}</div><div class="numeric-col ${Utils.getDataColorClass('prospect')}">${totali.prospect.toLocaleString()}</div><div class="numeric-col ${Utils.getDataColorClass('clienti')}">${totali.clienti.toLocaleString()}</div><div class="fatturato-col ${Utils.getDataColorClass('fatturato')}">${totali.valore.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ‚Ç¨</div><div class="percentage-col"><span class="badge ${Utils.getPerformanceBadgeClass(tassoTotale)}">${tassoTotale.toFixed(1)}%</span></div></div>`;
                container.innerHTML = html;
            }
        }

        class ModalRenderer {
            constructor(app) { this.app = app; }
            renderDrillDown() {
                const { performance } = this.app.data.processed;
                const realSources = Object.entries(performance).filter(([fonte, stats]) => !fonte.includes('totale') && stats.contatti > 0).sort((a, b) => b[1].valore - a[1].valore);
                let html = '<div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Fonte</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase">üö® Ghost %</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase">Contatti ‚Üí Lead</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase">Lead ‚Üí Prospect</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase">Prospect ‚Üí Clienti</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase">Totale</th></tr></thead><tbody class="divide-y divide-gray-200">';
                realSources.forEach(([fonte, stats]) => {
                    const rates = {
                        ghost: stats.contatti > 0 ? ((stats.ghost / stats.contatti) * 100) : 0,
                        contattiToLead: stats.contatti > 0 ? ((stats.lead / stats.contatti) * 100) : 0,
                        leadToProspect: stats.lead > 0 ? ((stats.prospect / stats.lead) * 100) : 0,
                        prospectToClienti: stats.prospect > 0 ? ((stats.clienti / stats.prospect) * 100) : 0,
                        totale: stats.contatti > 0 ? ((stats.clienti / stats.contatti) * 100) : 0
                    };
                    html += `<tr class="hover:bg-gray-50"><td class="px-4 py-3 font-semibold">${stats.nomeOriginale || fonte}</td>`;
                    html += this.createBadge(rates.ghost, true);
                    html += this.createBadge(rates.contattiToLead);
                    html += this.createBadge(rates.leadToProspect);
                    html += this.createBadge(rates.prospectToClienti);
                    html += this.createBadge(rates.totale);
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
                document.getElementById('modalContent').innerHTML = html;
            }
            createBadge(percentage, isGhost = false) {
                const color = Utils.getConversionColor(percentage, isGhost);
                return `<td class="px-4 py-3 text-center"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full" style="background-color: ${color}20; color: ${color}">${isGhost ? 'üö® ' : ''}${percentage.toFixed(1)}%</span></td>`;
            }
            renderPerformance() {
                const { performance } = this.app.data.processed;
                const realSources = Object.entries(performance).filter(([fonte, stats]) => !fonte.includes('totale') && stats.contatti > 0).sort((a, b) => b[1].valore - a[1].valore);
                const volumeMedio = realSources.reduce((sum, [_, s]) => sum + s.contatti, 0) / realSources.length;
                const conversioneMedia = realSources.reduce((sum, [_, s]) => sum + (s.contatti > 0 ? (s.clienti / s.contatti) * 100 : 0), 0) / realSources.length;
                let html = '<div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase">Fonte</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase">Quadrante</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase">Volume</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase">Conversione</th><th class="px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase">Fatturato</th></tr></thead><tbody class="divide-y divide-gray-200">';
                realSources.forEach(([fonte, stats]) => {
                    const conversione = stats.contatti > 0 ? ((stats.clienti / stats.contatti) * 100) : 0;
                    const quadrante = this.getQuadrante(stats.contatti, conversione, volumeMedio, conversioneMedia);
                    html += `<tr class="hover:bg-gray-50"><td class="px-4 py-3 font-semibold">${stats.nomeOriginale || fonte}</td>`;
                    html += `<td class="px-4 py-3 text-center"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${quadrante.color}">${quadrante.label}</span></td>`;
                    html += `<td class="px-4 py-3 text-center">${stats.contatti.toLocaleString()}</td>`;
                    html += `<td class="px-4 py-3 text-center">${conversione.toFixed(1)}%</td>`;
                    html += `<td class="px-4 py-3 text-center font-bold">${Utils.formatCurrency(stats.valore)}</td>`;
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
                document.getElementById('performanceModalContent').innerHTML = html;
            }
            getQuadrante(volume, conversione, volumeMedio, conversioneMedia) {
                if (volume >= volumeMedio && conversione >= conversioneMedia) return { label: 'üèÜ CAMPIONI', color: 'bg-green-100 text-green-800' };
                if (volume >= volumeMedio) return { label: 'üìà SCALABILI', color: 'bg-blue-100 text-blue-800' };
                if (conversione >= conversioneMedia) return { label: 'üíé PREMIUM', color: 'bg-purple-100 text-purple-800' };
                return { label: '‚ö†Ô∏è NICCHIA', color: 'bg-yellow-100 text-yellow-800' };
            }
        }

        class InsightsGenerator {
            constructor(processedData) {
                this.data = processedData;
            }

            generate() {
                const insights = [];
                const { funnel, conversionRates, performance } = this.data;

                if (!performance || Object.keys(performance).length === 0) {
                    return ['<p>Dati insufficienti per generare insights.</p>'];
                }

                const realSources = Object.values(performance).filter(stats => stats.contatti > 0);

                // 1. Top Performer (Valore)
                if (realSources.length > 0) {
                    const topPerformer = realSources.reduce((best, current) => 
                        current.valore > best.valore ? current : best, 
                        { valore: -1, nomeOriginale: 'N/D' }
                    );
                    if (topPerformer.valore > 0) {
                        insights.push(`<strong>Top Performer (Valore):</strong> La fonte <strong>${topPerformer.nomeOriginale}</strong> √® il motore primario di fatturato, generando <strong>${Utils.formatCurrency(topPerformer.valore)}</strong>.`);
                    }
                }

                // 2. Macchina da Conversione (Efficienza)
                const minContactsForConversionInsight = Math.max(10, funnel.contatti * 0.01);
                const relevantSourcesForConversion = realSources.filter(stats => stats.contatti >= minContactsForConversionInsight);

                if (relevantSourcesForConversion.length > 0) {
                    const conversionMachine = relevantSourcesForConversion.reduce((best, current) => {
                        const currentRate = current.contatti > 0 ? (current.clienti / current.contatti) : 0;
                        const bestRate = best.contatti > 0 ? (best.clienti / best.contatti) : 0;
                        return currentRate > bestRate ? current : best;
                    }, relevantSourcesForConversion[0]);
                    
                    if (conversionMachine) {
                        const rate = (conversionMachine.clienti / conversionMachine.contatti) * 100;
                        insights.push(`<strong>Macchina da Conversione:</strong> Il canale <strong>${conversionMachine.nomeOriginale}</strong> √® il pi√π letale, convertendo il <strong>${rate.toFixed(1)}%</strong> dei contatti in clienti.`);
                    }
                }

                // 3. Clienti Premium (Qualit√†/AOV)
                const sourcesWithClients = realSources.filter(stats => stats.clienti > 0);
                if (sourcesWithClients.length > 0) {
                    const premiumSource = sourcesWithClients.reduce((best, current) => {
                        const currentAOV = current.valore / current.clienti;
                        const bestAOV = best.clienti > 0 ? (best.valore / best.clienti) : 0;
                        return currentAOV > bestAOV ? current : best;
                    }, { valore: 0, clienti: 0, nomeOriginale: 'N/D' });

                    if (premiumSource.clienti > 0) {
                        const aov = premiumSource.valore / premiumSource.clienti;
                        insights.push(`<strong>Clienti Premium:</strong> I clienti da <strong>${premiumSource.nomeOriginale}</strong> sono i pi√π preziosi, con un valore medio di vendita di <strong>${Utils.formatCurrency(aov)}</strong>.`);
                    }
                }

                // 4. L'Anello Debole (Processo)
                const drops = [];
                if (funnel.contatti > 0 && funnel.lead > 0) {
                    drops.push({ name: 'da Contatti a Lead', value: 1 - (funnel.lead / funnel.contatti) });
                }
                if (funnel.lead > 0 && funnel.prospect > 0) {
                    drops.push({ name: 'da Lead a Prospect', value: 1 - (funnel.prospect / funnel.lead) });
                }
                if (funnel.prospect > 0 && funnel.clienti > 0) {
                    drops.push({ name: 'da Prospect a Clienti', value: 1 - (funnel.clienti / funnel.prospect) });
                }

                if (drops.length > 0) {
                    const weakestLink = drops.reduce((max, current) => current.value > max.value ? current : max, { value: -1, name: 'N/D' });
                    if (weakestLink.value >= 0) {
                        insights.push(`<strong>L'Anello Debole:</strong> La pi√π grande emorragia di opportunit√† si verifica nel passaggio <strong>${weakestLink.name}</strong> (calo del <strong>${(weakestLink.value * 100).toFixed(1)}%</strong>).`);
                    }
                }

                // 5. ALLARME Ghost
                if (conversionRates.ghostPercentage > CONFIG.GHOST_THRESHOLDS.WARNING) {
                    insights.push(`<strong>ALLARME Ghost:</strong> Il <strong>${conversionRates.ghostPercentage.toFixed(1)}%</strong> dei contatti non viene mai lavorato, rappresentando una perdita secca di potenziale.`);
                } else if (conversionRates.ghostPercentage < CONFIG.GHOST_THRESHOLDS.EXCELLENT) {
                    insights.push(`<strong>Ghost Ottimizzato:</strong> Solo il <strong>${conversionRates.ghostPercentage.toFixed(1)}%</strong> dei contatti viene disperso prima del contatto iniziale.`);
                }

                const icons = {
                    'Top Performer': 'üéØ',
                    'Macchina da Conversione': '‚öôÔ∏è',
                    'Clienti Premium': 'üíé',
                    'L\'Anello Debole': 'üìâ',
                    'ALLARME Ghost': 'üö®',
                    'Ghost Ottimizzato': '‚úÖ'
                };

                return insights.map(insight => {
                    const key = Object.keys(icons).find(k => insight.includes(k));
                    const iconHtml = key ? `<span class="mr-3 text-xl">${icons[key]}</span>` : '';
                    return `<div class="bg-white/10 rounded-lg p-4 backdrop-filter backdrop-blur-sm flex items-center">${iconHtml}<div class="text-white/90">${insight}</div></div>`;
                });
            }
        }

        class DataExporter {
            constructor(performance) { this.performance = performance; }
            toCSV(filename) {
                const csvData = [['Fonte', 'Contatti', 'Lead', 'Prospect', 'Clienti', 'Valore', 'Tasso Conversione %']];
                Object.entries(this.performance).filter(([fonte, stats]) => !fonte.includes('totale') && stats.contatti > 0).sort((a, b) => b[1].valore - a[1].valore).forEach(([fonte, stats]) => {
                    const tasso = ((stats.clienti / (stats.contatti || 1)) * 100).toFixed(1);
                    csvData.push([stats.nomeOriginale || fonte, stats.contatti, stats.lead, stats.prospect, stats.clienti, '‚Ç¨ ' + stats.valore.toLocaleString('it-IT', {minimumFractionDigits: 2}), tasso + '%']);
                });
                const totali = Utils.calculateTotals(this.performance);
                const tassoTotale = ((totali.clienti / (totali.contatti || 1)) * 100).toFixed(1);
                csvData.push(['TOTALE', totali.contatti, totali.lead, totali.prospect, totali.clienti, '‚Ç¨ ' + totali.valore.toLocaleString('it-IT'), tassoTotale + '%']);
                const csvContent = csvData.map(row => row.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const app = new DashboardApp();
            app.init();
        });
    </script>
</body>
</html>