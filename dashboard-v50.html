<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Intelligence v50 (API Only) - Centro di Comando CRM</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- <• GOOGLE SHEETS API -->
    <script async defer src="https://apis.google.com/js/api.js?onload=handleClientLoad"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>

    <style>
        :root {
            --color-primary: #667eea;
            --color-primary-dark: #764ba2;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #3b82f6;
            --color-contatti: #8b5a2b;
            --color-lead: #16a34a;
            --color-prospect: #2563eb;
            --color-clienti: #ec4899;
            --color-ghost: #dc2626;
            --color-fatturato: #1f2937;
            --perf-critical: #dc2626;
            --perf-low: #ea580c;
            --perf-medium: #ca8a04;
            --perf-good: #16a34a;
            --perf-excellent: #15803d;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.6s ease;
        }

        * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
        .gradient-bg { background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%); }
        .card-hover { transition: all var(--transition-normal); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); }
        .status-indicator { display: inline-flex; align-items: center; gap: var(--spacing-xs); }
        .fade-in { animation: fadeIn var(--transition-slow) ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .debug-panel { background: #1a1a1a; color: #00ff00; font-family: 'Courier New', monospace; font-size: 12px; padding: var(--spacing-md); border-radius: 8px; margin: var(--spacing-md) 0; max-height: 300px; overflow-y: auto; }
        .debug-section { border-bottom: 1px solid #333; padding: var(--spacing-sm) 0; }
        .debug-error { color: #ff4444; }
        .debug-success { color: #44ff44; }
        .debug-warning { color: #ffaa44; }

        .export-btn, .section-export-btn {
            transition: all var(--transition-normal);
        }
        .export-btn:hover:not(:disabled), .section-export-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .chart-clickable { cursor: pointer; transition: opacity var(--transition-fast); }
        .chart-clickable:hover { opacity: 0.8; }
        .modal-overlay { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .modal-content { max-height: 80vh; overflow-y: auto; }
        .filter-select, .date-input { width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; background: white; font-size: 0.875rem; transition: all var(--transition-fast); position: relative; z-index: 1; }
        .filter-select { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .filter-select:focus, .date-input:focus { outline: none; border-color: var(--color-info); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); z-index: 10; }
        .date-inputs-container { display: none; position: relative; z-index: 1; }
        .date-inputs-container.show { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-top: var(--spacing-md); }
        .date-input::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 1; }
        .data-contatti { color: var(--color-contatti); font-weight: 600; }
        .data-lead { color: var(--color-lead); font-weight: 600; }
        .data-prospect { color: var(--color-prospect); font-weight: 600; }
        .data-clienti { color: var(--color-clienti); font-weight: 600; }
        .data-fatturato { color: var(--color-fatturato); font-weight: 600; }
        .performance-table { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 1fr; gap: var(--spacing-md); align-items: center; padding: 0.75rem var(--spacing-md); border-bottom: 1px solid #e5e7eb; transition: background-color var(--transition-fast); }
        .performance-table.header { background: #f8fafc; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db; position: sticky; top: 0; z-index: 10; }
        .performance-table:hover:not(.header) { background: #f9fafb; }
        .performance-table .numeric-col { text-align: center; font-variant-numeric: tabular-nums; font-weight: 600; }
        .performance-table .fonte-col { text-align: left; font-weight: 600; color: var(--color-fatturato); }
        .performance-table .percentage-col { text-align: center; font-variant-numeric: tabular-nums; }
        .performance-table .fatturato-col { text-align: center; font-variant-numeric: tabular-nums; font-weight: 600; }
        .badge { display: inline-flex; padding: 0.25rem 0.75rem; font-weight: 700; font-size: 0.9rem; border-radius: 9999px; letter-spacing: 0.5px; }
        .badge-critical { background-color: #fee2e2; color: var(--perf-critical); }
        .badge-low { background-color: #ffedd5; color: var(--perf-low); }
        .badge-medium { background-color: #fef9c3; color: var(--perf-medium); }
        .badge-good { background-color: #dcfce7; color: var(--perf-good); }
        .badge-excellent { background-color: #bbf7d0; color: var(--perf-excellent); }
        .totali-row { background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-top: 2px solid #d1d5db; font-weight: 700; color: #111827; }
        .agg-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.875rem; color: #4b5563; transition: all 0.2s ease; border: none; background-color: transparent; cursor: pointer; }
        .agg-btn.active { color: #2563eb; background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        @media (max-width: 1024px) { .performance-table { grid-template-columns: 1.5fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr; gap: var(--spacing-sm); padding: var(--spacing-sm); font-size: 0.875rem; } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-3xl mr-3"></i>
                    <span class="text-3xl mr-3"><¯</span>
                    <div>
                        <h1 class="text-2xl font-bold">Dashboard v50 - Centro di Comando CRM</h1>
                        <p class="text-purple-200 text-sm">Google Sheets API Real-time (Test Version)</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="exportFullDashboard" class="export-btn bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-file-pdf mr-2"></i>
                        Esporta Dashboard
                    </button>
                    <button id="toggleDebug" class="bg-red-500 text-white px-3 py-1 rounded text-sm">=à Debug</button>
                    <div id="authStatus" class="status-indicator bg-red-500/80 px-3 py-1 rounded-full text-sm text-white">
                        <i class="fas fa-lock"></i>
                        API Non Connessa
                    </div>
                    <button id="authorize_api" style="display: none;" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center shadow-sm transition-all">
                        <i class="fab fa-google mr-2"></i>
                        Connetti API
                    </button>
                    <button id="signout_api" style="display: none;" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center shadow-sm transition-all">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Disconnetti
                    </button>
                    <span id="dataStatus" class="status-indicator bg-yellow-500/80 px-3 py-1 rounded-full text-sm">
                        <i class="fas fa-circle text-yellow-300"></i>
                        In attesa dei dati
                    </span>
                    <span id="dateTimeDisplay" class="status-indicator bg-white/20 px-3 py-1 rounded-full text-sm hidden">
                        <i class="fas fa-clock mr-2"></i>
                        <span id="dateTimeValue"></span>
                    </span>
                </div>
            </div>
        </div>
    </header>

    <!-- DEBUG PANEL -->
    <div id="debugPanel" class="container mx-auto px-4 py-2" style="display: none;">
        <div class="debug-panel">
            <h3 class="debug-success">=à DEBUG CONSOLE - DASHBOARD V50 (API ONLY)</h3>
            <div id="debugContent">
                <div class="debug-section">Sistema inizializzato. In attesa di autenticazione...</div>
            </div>
        </div>
    </div>

    <!-- MODAL DRILL-DOWN DISPERSIONI -->
    <div id="drillDownModal" class="fixed inset-0 z-50 hidden modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full modal-content">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800" id="modalTitle">Analisi Dispersioni e Tassi di Conversione per Fonte</h3>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div id="modalContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PERFORMANCE PER FONTE -->
    <div id="performanceModal" class="fixed inset-0 z-50 hidden modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full modal-content">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800" id="performanceModalTitle">=Ž Performance Dettagliata per Fonte</h3>
                    <button id="closePerformanceModal" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div id="performanceModalContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6">
        <!-- Sezione Caricamento API ONLY -->
        <div class="mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold mb-6 flex items-center text-gray-800">
                    <i class="fas fa-bolt text-blue-500 mr-3 text-2xl"></i>
                    ¡ Caricamento Rapido da Google Sheets API
                </h2>

                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="font-semibold text-blue-900 text-lg flex items-center">
                                <i class="fas fa-database text-yellow-500 mr-2"></i>
                                Carica tutti i fogli con un solo click
                            </h3>
                            <p class="text-sm text-blue-700 mt-1">
                                Lead, Campagne, Sales, Weekly - tutti automaticamente
                            </p>
                        </div>
                        <div class="bg-blue-100 px-3 py-1 rounded-full">
                            <span class="text-xs font-semibold text-blue-800">MODALITÀ TEST V50</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <label for="globalSpreadsheetId" class="block text-sm font-medium text-blue-800 mb-1">
                                Spreadsheet ID
                            </label>
                            <input type="text" id="globalSpreadsheetId"
                                   class="w-full p-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                                   placeholder="1X0NahLnQ9nUzCg0FwDmZWXgXDYtITrIzPxzCW1xrXh4"
                                   value="1X0NahLnQ9nUzCg0FwDmZWXgXDYtITrIzPxzCW1xrXh4">
                        </div>
                        <div class="pt-6">
                            <button id="quickLoadAPI"
                                    class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-8 py-3 rounded-lg font-semibold text-base flex items-center gap-2 shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                                <i class="fas fa-rocket"></i>
                                Carica Tutto da API
                            </button>
                        </div>
                    </div>

                    <div class="mt-3 text-xs text-blue-600 bg-blue-100 rounded-lg p-3">
                        <strong>=¡ Come ottenere lo Spreadsheet ID:</strong>
                        Apri il tuo Google Sheet e copia l'ID dall'URL:
                        <code class="bg-white px-2 py-1 rounded text-blue-800 font-mono">https://docs.google.com/spreadsheets/d/<strong class="text-pink-600">ID_QUI</strong>/edit</code>
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <button id="processButton" disabled class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-4 rounded-xl font-semibold text-lg disabled:opacity-50 disabled:cursor-not-allowed hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105 shadow-lg">
                        =€ Elabora Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- SEZIONE FILTRI -->
        <div class="mb-8" id="filtersSection" style="display: none;">
            <div class="gradient-bg text-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold flex items-center text-purple-200">
                        <i class="fas fa-filter mr-3 text-2xl text-purple-200"></i>
                        <› Filtri per l'Analisi
                    </h2>
                    <div class="flex items-center space-x-2">
                        <span id="filtersActiveIndicator" class="text-sm text-purple-200 hidden">
                            <i class="fas fa-check-circle text-green-300 mr-1"></i>
                            <span id="filtersActiveCount">0</span> filtri attivi
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-6">
                    <div class="relative">
                        <label class="block text-sm font-semibold text-purple-200 mb-2">
                            <i class="fas fa-calendar text-blue-300 mr-1"></i>Periodo
                        </label>
                        <select id="filterPeriodo" class="filter-select text-gray-800">
                            <option value="tutto">Tutto</option>
                            <option value="7">Ultimi 7 giorni</option>
                            <option value="14">Ultimi 14 giorni</option>
                            <option value="30">Ultimi 30 giorni</option>
                            <option value="90">Ultimi 90 giorni</option>
                            <option value="custom">Personalizzato</option>
                        </select>

                        <div id="customDateInputs" class="date-inputs-container">
                            <div>
                                <label class="block text-xs font-medium text-purple-200 mb-1">Data Inizio</label>
                                <input type="date" id="dateStart" class="date-input text-gray-800" placeholder="gg/mm/aaaa">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-purple-200 mb-1">Data Fine</label>
                                <input type="date" id="dateEnd" class="date-input text-gray-800" placeholder="gg/mm/aaaa">
                            </div>
                        </div>
                    </div>

                    <div class="relative">
                        <label class="block text-sm font-semibold text-purple-200 mb-2">
                            <i class="fas fa-globe text-green-300 mr-1"></i>Fonte
                        </label>
                        <select id="filterFonte" class="filter-select text-gray-800">
                            <option value="">Tutte le fonti</option>
                        </select>
                    </div>

                    <div class="relative">
                        <label class="block text-sm font-semibold text-purple-200 mb-2">
                            <i class="fas fa-bullhorn text-purple-300 mr-1"></i>Mezzo
                        </label>
                        <select id="filterMezzo" class="filter-select text-gray-800">
                            <option value="">Tutti i mezzi</option>
                        </select>
                    </div>

                    <div class="relative">
                        <label class="block text-sm font-semibold text-purple-200 mb-2">
                            <i class="fas fa-store text-cyan-300 mr-1"></i>Punto Vendita
                        </label>
                        <select id="filterPuntoVendita" class="filter-select text-gray-800">
                            <option value="">Tutti i punti vendita</option>
                            <option value="Seregno">Seregno</option>
                            <option value="Zanica">Zanica</option>
                        </select>
                    </div>

                    <div class="relative">
                        <label class="block text-sm font-semibold text-purple-200 mb-2">
                            <i class="fas fa-redo text-pink-300 mr-1"></i>Riattivazione
                        </label>
                        <select id="filterRiattivazione" class="filter-select text-gray-800">
                            <option value="">Tutte</option>
                            <option value="VERO">VERO</option>
                            <option value="FALSO">FALSO</option>
                        </select>
                    </div>

                    <div class="relative">
                        <label class="block text-sm font-semibold text-purple-200 mb-2">
                            <i class="fas fa-user-tag text-indigo-300 mr-1"></i>Person Type
                        </label>
                        <select id="filterPersonType" class="filter-select text-gray-800">
                            <option value="">Tutti i tipi</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-center space-x-4">
                    <button id="applyFilters" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg font-semibold flex items-center transition-all transform hover:scale-105 shadow-lg">
                        <i class="fas fa-check mr-2"></i> Applica Filtri
                    </button>
                    <button id="resetFilters" class="bg-gray-600 hover:bg-gray-700 text-white px-8 py-3 rounded-lg font-semibold flex items-center transition-all transform hover:scale-105 shadow-lg">
                        <i class="fas fa-undo mr-2"></i>= Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard Content COMPLETA -->
        <div id="dashboardContent" class="hidden">
            <!-- KPI Funnel di Conversione -->
            <div id="funnelKpiSection" class="mb-8 fade-in">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                    <h2 class="text-2xl font-bold flex items-center text-gray-800">
                        <i class="fas fa-funnel-dollar text-blue-500 mr-3"></i>
                        <¯ Funnel di Conversione
                    </h2>
                    <button id="exportFunnelKpi" class="section-export-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold text-sm py-2 px-4 rounded-full shadow-sm" title="Esporta questa sezione in PDF">
                        <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
                    <!-- Contatti Totali -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-users text-purple-500 text-3xl"></i>
                            <span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded-full font-medium">Totale</span>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-800" id="kpiTotalContacts">0</h3>
                        <p class="text-gray-600 text-sm font-medium">Contatti Totali</p>
                    </div>

                    <!-- Lead -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-user-check text-green-500 text-3xl"></i>
                            <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full font-medium">Lead</span>
                        </div>
                        <h3 class="text-3xl font-bold text-green-600" id="kpiLeads">0</h3>
                        <p class="text-gray-600 text-sm font-medium">Lead Qualificati</p>
                        <div class="mt-2">
                            <span class="text-xs text-gray-500 font-medium" id="kpiLeadsPerc">0%</span>
                        </div>
                    </div>

                    <!-- Prospect -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-handshake text-blue-500 text-3xl"></i>
                            <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-medium">Prospect</span>
                        </div>
                        <h3 class="text-3xl font-bold text-blue-600" id="kpiProspects">0</h3>
                        <p class="text-gray-600 text-sm font-medium">Offerte Sviluppate</p>
                        <div class="mt-2">
                            <span class="text-xs text-gray-500 font-medium" id="kpiProspectsPerc">0%</span>
                        </div>
                    </div>

                    <!-- Clienti -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-trophy text-pink-500 text-3xl"></i>
                            <span class="text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded-full font-medium">Clienti</span>
                        </div>
                        <h3 class="text-3xl font-bold text-pink-600" id="kpiClients">0</h3>
                        <p class="text-gray-600 text-sm font-medium">Vendite Chiuse</p>
                        <div class="mt-2">
                            <span class="text-xs text-gray-500 font-medium" id="kpiClientsPerc">0%</span>
                        </div>
                    </div>

                    <!-- Ghost -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-ghost text-red-500 text-3xl"></i>
                            <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full font-medium">Ghost</span>
                        </div>
                        <h3 class="text-3xl font-bold text-red-600" id="kpiGhosts">0</h3>
                        <p class="text-gray-600 text-sm font-medium">Non Contattati</p>
                        <div class="mt-2">
                            <span class="text-xs text-gray-500 font-medium" id="kpiGhostsPerc">0%</span>
                        </div>
                    </div>

                    <!-- Non Lavorati -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-clock text-orange-500 text-3xl"></i>
                            <span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full font-medium">Pending</span>
                        </div>
                        <h3 class="text-3xl font-bold text-orange-600" id="kpiNotWorked">0</h3>
                        <p class="text-gray-600 text-sm font-medium">Non Lavorati</p>
                        <div class="mt-2">
                            <span class="text-xs text-gray-500 font-medium" id="kpiNotWorkedPerc">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Performance Economica -->
            <div id="economicKpiSection" class="mb-8 fade-in">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                    <h2 class="text-2xl font-bold flex items-center text-gray-800">
                        <i class="fas fa-chart-line text-green-500 mr-3"></i>
                        =° Performance Economica
                    </h2>
                    <button id="exportEconomicKpi" class="section-export-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold text-sm py-2 px-4 rounded-full shadow-sm" title="Esporta questa sezione in PDF">
                        <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Valore Venduto Card -->
                    <div class="bg-gradient-to-r from-green-400 to-blue-500 rounded-xl shadow-lg p-6 text-white col-span-1 md:col-span-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm mb-2 font-medium">Valore Totale Venduto</p>
                                <h2 class="text-4xl font-bold" id="kpiTotalValue">¬ 0</h2>
                            </div>
                            <div class="text-right">
                                <p class="text-green-100 text-sm mb-2 font-medium">Valore Medio Vendita (AOV)</p>
                                <h3 class="text-2xl font-semibold" id="kpiAvgValue">¬ 0</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI Efficienza Pubblicitaria -->
            <div id="advertisingKpiSection" class="mb-8 fade-in">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                    <h2 class="text-2xl font-bold flex items-center text-gray-800">
                        <i class="fas fa-bullseye text-red-500 mr-3"></i>
                        =Ê Efficienza Pubblicitaria
                    </h2>
                    <button id="exportAdvertisingKpi" class="section-export-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold text-sm py-2 px-4 rounded-full shadow-sm" title="Esporta questa sezione in PDF">
                        <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-4">
                    <!-- Spesa Pubblicitaria -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-euro-sign text-blue-500 text-3xl"></i>
                            <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full font-medium">Spesa</span>
                        </div>
                        <h3 class="text-2xl font-bold text-blue-600" id="kpiAdSpend">¬ 0</h3>
                        <p class="text-gray-600 text-sm font-medium">Spesa Pubblicitaria</p>
                    </div>

                    <!-- ROI -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-percentage text-green-500 text-3xl"></i>
                            <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full font-medium">ROI</span>
                        </div>
                        <h3 class="text-2xl font-bold" id="kpiROI">0X</h3>
                        <p class="text-gray-600 text-sm font-medium">Return on Investment</p>
                    </div>

                    <!-- Valore del Contatto -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-dollar-sign text-purple-500 text-3xl"></i>
                            <span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded-full font-medium">Valore</span>
                        </div>
                        <h3 class="text-2xl font-bold text-purple-600" id="kpiContactValue">¬ 0</h3>
                        <p class="text-gray-600 text-sm font-medium">Valore del Contatto</p>
                    </div>

                    <!-- CPC -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-mouse-pointer text-orange-500 text-3xl"></i>
                            <span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full font-medium">CPC</span>
                        </div>
                        <h3 class="text-2xl font-bold text-orange-600" id="kpiCPC">¬ 0</h3>
                        <p class="text-gray-600 text-sm font-medium">Costo per Contatto</p>
                    </div>

                    <!-- CPL -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-user-check text-yellow-500 text-3xl"></i>
                            <span class="text-xs bg-yellow-100 text-yellow-600 px-2 py-1 rounded-full font-medium">CPL</span>
                        </div>
                        <h3 class="text-2xl font-bold text-yellow-600" id="kpiCPL">¬ 0</h3>
                        <p class="text-gray-600 text-sm font-medium">Costo per Lead</p>
                    </div>

                    <!-- CPO -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-file-signature text-indigo-500 text-3xl"></i>
                            <span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full font-medium">CPO</span>
                        </div>
                        <h3 class="text-2xl font-bold text-indigo-600" id="kpiCPO">¬ 0</h3>
                        <p class="text-gray-600 text-sm font-medium">Costo per Offerta</p>
                    </div>

                    <!-- CPV -->
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-3">
                            <i class="fas fa-eye text-pink-500 text-3xl"></i>
                            <span class="text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded-full font-medium">CPV</span>
                        </div>
                        <h3 class="text-2xl font-bold text-pink-600" id="kpiCPV">¬ 0</h3>
                        <p class="text-gray-600 text-sm font-medium">Costo per Vendita</p>
                    </div>
                </div>
            </div>

            <!-- CHARTS ROW -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 fade-in">
                <!-- Funnel Chart -->
                <div id="funnelChartSection" class="bg-white rounded-xl shadow-lg border border-gray-100">
                    <div class="gradient-bg text-white p-4 rounded-t-xl flex justify-between items-center">
                        <h3 class="text-xl font-bold">=È Funnel di Conversione</h3>
                        <button id="exportFunnelChart" class="section-export-btn bg-white/20 hover:bg-white/30 text-white font-semibold text-sm py-1 px-3 rounded-full" title="Esporta grafico in PDF">
                            <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                        </button>
                    </div>
                    <div class="p-6" style="height: 350px;">
                        <canvas id="funnelChart"></canvas>
                    </div>
                </div>

                <!-- Card Tassi Conversione -->
                <div id="conversionChartSection" class="bg-white rounded-xl shadow-lg border border-gray-100">
                    <div class="gradient-bg text-white p-4 rounded-t-xl flex justify-between items-center">
                        <h3 class="text-xl font-bold flex items-center">
                            =Ê Dispersioni e Tassi di Conversione
                        </h3>
                        <button id="drillDownBtn" class="text-sm bg-white/20 text-white px-3 py-1 rounded-full hover:bg-white/30 transition-colors">
                            <i class="fas fa-search-plus mr-1"></i>
                            Analisi Dettagliata
                        </button>
                    </div>
                    <div class="p-6 chart-clickable" style="height: 350px;">
                        <canvas id="conversionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SEZIONE EFFICIENZA -->
            <div id="efficiencySection" class="mb-8 fade-in">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                    <h2 class="text-2xl font-bold flex items-center text-gray-800">
                        =, Indici di Efficienza del Funnel
                    </h2>
                    <button id="exportEfficiency" class="section-export-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-semibold text-sm py-2 px-4 rounded-full shadow-sm" title="Esporta questa sezione in PDF">
                        <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                    </button>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 ml-1">Rapporti di Sforzo</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">

                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Contatti / Offerta</p>
                                <i class="fas fa-users text-blue-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-blue-600" id="effContattiPerOfferta">0</p>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Lead / Offerta</p>
                                <i class="fas fa-user-check text-blue-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-blue-600" id="effLeadPerOfferta">0</p>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Contatti / Vendita</p>
                                <i class="fas fa-users text-green-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-green-600" id="effContattiPerVendita">0</p>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Lead / Vendita</p>
                                <i class="fas fa-user-check text-green-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-green-600" id="effLeadPerVendita">0</p>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Offerte / Vendita</p>
                                <i class="fas fa-handshake text-pink-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-pink-600" id="effOffertePerVendita">0</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 ml-1">Tassi di Conversione Diretti</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">

                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Offerte / Contatti (O/C)</p>
                                <i class="fas fa-percentage text-blue-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-blue-600" id="effRateOC">0.0%</p>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Offerte / Lead (O/L)</p>
                                <i class="fas fa-percentage text-blue-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-blue-600" id="effRateOL">0.0%</p>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Vendite / Contatti (V/C)</p>
                                <i class="fas fa-percentage text-green-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-green-600" id="effRateVC">0.0%</p>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Vendite / Lead (V/L)</p>
                                <i class="fas fa-percentage text-green-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-green-600" id="effRateVL">0.0%</p>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-4 card-hover border border-gray-100 transition-all">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-semibold text-gray-600">Vendite / Offerte (V/O)</p>
                                <i class="fas fa-percentage text-pink-300 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-pink-600" id="effRateVO">0.0%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEZIONE ANALISI TEMPORALE -->
            <div id="temporalAnalysisSection" class="mb-8 fade-in">
                <div class="bg-white rounded-xl shadow-lg border border-gray-100">
                    <div class="gradient-bg text-white p-4 rounded-t-xl flex justify-between items-center flex-wrap gap-4">
                        <h3 class="text-xl font-bold flex items-center">
                            =È Andamento del Funnel
                        </h3>
                        <div class="flex items-center space-x-4">
                            <div class="bg-white/20 p-1 rounded-lg flex items-center space-x-1">
                                <button id="aggWeekly" class="agg-btn active">Settimanale</button>
                                <button id="aggMonthly" class="agg-btn">Mensile</button>
                                <button id="aggAnnual" class="agg-btn">Annuale</button>
                            </div>
                            <button id="exportTemporalFunnel" class="section-export-btn bg-white/20 hover:bg-white/30 text-white font-semibold text-sm py-1 px-3 rounded-full" title="Esporta grafico in PDF">
                                <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="temporalFunnelChartContainer" style="height: 400px;">
                            <canvas id="temporalFunnelChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="temporalEconomicAnalysisSection" class="mb-8 fade-in">
                <div class="bg-white rounded-xl shadow-lg border border-gray-100">
                    <div class="gradient-bg text-white p-4 rounded-t-xl flex justify-between items-center flex-wrap gap-4">
                        <h3 class="text-xl font-bold flex items-center">
                            =° Andamento Economico
                        </h3>
                        <div class="flex items-center space-x-4">
                            <div class="bg-white/20 p-1 rounded-lg flex items-center space-x-1">
                                <button id="aggMonthlyEco" class="agg-btn active">Mensile</button>
                                <button id="aggAnnualEco" class="agg-btn">Annuale</button>
                            </div>
                            <button id="exportTemporalEconomic" class="section-export-btn bg-white/20 hover:bg-white/30 text-white font-semibold text-sm py-1 px-3 rounded-full" title="Esporta grafico in PDF">
                                <i class="fas fa-file-pdf mr-2"></i>Esporta PDF
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div id="temporalEconomicChartContainer" style="height: 400px;">
                            <canvas id="temporalEconomicChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHART A BOLLE PERFORMANCE PER FONTE -->
            <div id="performanceChartSection" class="mb-8 fade-in">
                <div class="bg-white rounded-xl shadow-lg border border-gray-100">
                    <div class="gradient-bg text-white p-4 rounded-t-xl flex justify-between items-center">
                        <h3 class="text-xl font-bold flex items-center">
                            =Ž Performance per Fonte - Valore vs Efficienza
                        </h3>
                        <button id="performanceDrillDownBtn" class="text-sm bg-white/20 text-white px-3 py-1 rounded-full hover:bg-white/30 transition-colors">
                            <i class="fas fa-search-plus mr-1"></i>
                            Analisi Dettagliata
                        </button>
                    </div>
                    <div class="p-6 chart-clickable" style="height: 450px;">
                        <canvas id="performanceChart"></canvas>
                    </div>
                    <div class="p-6 pt-0 text-sm text-gray-600">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                                <span><strong>Asse X:</strong> Volume Contatti</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                <span><strong>Asse Y:</strong> Tasso Conversione %</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-purple-500 rounded-full mr-2"></div>
                                <span><strong>Dimensione:</strong> Fatturato Totale</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABELLA PERFORMANCE -->
            <div id="performanceTableSection" class="mb-8 fade-in">
                <div class="bg-white rounded-xl shadow-lg border border-gray-100">
                    <div class="gradient-bg text-white p-6 flex items-center justify-between rounded-t-xl">
                        <div class="flex items-center">
                            <h2 class="text-xl font-bold">=Ê Performance Dettagliata per Fonte</h2>
                        </div>
                        <div class="flex space-x-3">
                            <button id="exportCSV" class="export-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center shadow-sm">
                                <i class="fas fa-file-csv mr-2"></i>
                                Esporta CSV
                            </button>
                            <button id="exportPDF" class="export-btn bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center shadow-sm">
                                <i class="fas fa-file-pdf mr-2"></i>
                                Esporta PDF
                            </button>
                        </div>
                    </div>

                    <div id="performanceTableContainer" class="p-6">
                        <!-- Tabella generata dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Insights Strategici -->
            <div id="insightsPanel" class="mb-8 fade-in">
                <div class="bg-gradient-to-r from-purple-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                    <h2 class="text-2xl font-bold mb-4 flex items-center">
                        >à Insights Strategici
                    </h2>
                    <div id="insightsContent" class="space-y-4">
                        <!-- Dinamico -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =' CONFIGURAZIONE - V50 con credenziali fornite
        const CONFIG = {
            DEBUG_MODE: false,
            MAX_DEBUG_ENTRIES: 100,
            GENERIC_CHART_COLORS: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#f97316', '#84cc16', '#ec4899', '#6b7280'],
            CHART_COLORS: {
                contatti: 'rgba(139, 90, 43, 0.8)',
                lead: 'rgba(34, 197, 94, 0.8)',
                prospect: 'rgba(59, 130, 246, 0.8)',
                clienti: 'rgba(236, 72, 153, 0.8)',
                spesa: 'rgba(59, 130, 246, 0.6)',
                fatturato: 'rgba(16, 185, 129, 0.6)',
                vendite: 'rgba(139, 92, 246, 1)',
                roi: 'rgba(249, 115, 22, 1)'
            },
            PERFORMANCE_THRESHOLDS: {
                CRITICAL: 5, LOW: 10, MEDIUM: 15, GOOD: 25
            },
            GHOST_THRESHOLDS: {
                EXCELLENT: 10, WARNING: 20
            },
            // <• GOOGLE SHEETS API CONFIGURATION
            API: {
                API_KEY: 'AIzaSyAUsHCDxnOMq0niHUxcdlyS42Oe_oQIlhE',
                CLIENT_ID: '28262641465-or41dk7e05fj2gj6eq2g45djgr1v2r0c.apps.googleusercontent.com',
                DISCOVERY_DOCS: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                SCOPES: "https://www.googleapis.com/auth/spreadsheets.readonly",
                SHEET_NAMES: {
                    lead: 'Lead',
                    campaigns: 'Report Campagne',
                    sales: 'Sales',
                    weekly: 'Weekly'
                }
            }
        };
